<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>基于工作量证明（PoW）的验证码系统的简单实现 - 黄阿信</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="基于工作量证明（PoW）的验证码系统的简单实现 - 黄阿信" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://yalexin.gitee.io/2023/06/19/%E5%9F%BA%E4%BA%8E%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%EF%BC%88POW%EF%BC%89%E7%9A%84%E9%AA%8C%E8%AF%81%E7%A0%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-06-19T02:06:53.000Z" />
  
  <meta property="og:article:author" content="YaleXin" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
</head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/博客/">博客</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>June</span>
            <span>19,</span>
            <span>2023</span>
        </div>
        

        <h1 class="title">基于工作量证明（PoW）的验证码系统的简单实现</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CAPTCHA全称Completely Automated Public Turing Test，译为全自动区分计算机和人类的图灵测试，是指各种认证方法，这些方法利用一个对于人类来说很简单但对机器来说很难的挑战来测试用户，以验证用户是否为人类。<a id="more"></a></p>
<p>随着人工智能技术不断发展，许多传统的验证码测试系统被计算机轻易通过，因此许多厂商不断推出各种创新性的方法，然而大多数情况下机器根据一些标注数据进行训练后，也能够快速适应新的这些系统，反倒是对于用户而言，要花时间学习新的验证方式，徒增客户烦恼。</p>
<p>现在的一些验证码过于奇葩，例如：</p>
<p><img src="https://cdn.yalexin.top/image-20230619102235861.png" alt="image-20230619102235861"></p>
<p><img src="https://cdn.yalexin.top/image-20230619102252640.png" alt="image-20230619102252640"></p>
<p><img src="https://cdn.yalexin.top/image-20230619102438119.png" alt="image-20230619102438119"></p>
<p>在我看来，现在的验证码系统多多少少有些本末倒置了，把人类难住了，计算机却放过了。</p>
<p>因此有必要对现有的验证码系统做出改进。</p>
<h2 id="工作量证明POW"><a href="#工作量证明POW" class="headerlink" title="工作量证明POW"></a>工作量证明POW</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>工作量证明即在获取我的服务之前，你需要向我证明你做了一定量的工作。</p>
<p>很常用的一种方法是通过寻找哈希值的方式，即你花费算力，寻找某些特定条件的哈希值，由于哈希函数的不可逆性和不可预测性，你不得不通过迭代的方式进行寻找，但是对于我而言，验证过程是很容易的，只需要将你给的值计算一遍哈希值，检查哈希值是否符合条件，只要符合条件，就说明你的确做了一定量的工作。</p>
<p>为了防止你使用彩虹表的方式记录下指定字符串的哈希值，我要给一个随机字符串<code>prefix</code>，你再在这基础之上寻找一个后缀，使得两者拼接后的哈希值符合条件。</p>
<p>以上就是一个简单的基于pow的验证码系统的大致原理了，下面是实现过程</p>
<blockquote>
<p>好吧，我承认这篇文章的确有些标题党了，这个方式并不是真正意义上的captcha，因为它并没有往区分人类与机器人的功能上走，但是今天的验证码系统的目的是什么？绝大多数是为了防止机器人访问吧，例如在登录页面放入验证码系统，防止机器人通过口令爆破的方式获取指定用户的密码，即先判断是人类，再判断输入的密码，因为人类输入内容速度较慢，以人工的方式爆破密码不现实。</p>
<p>而基于pow的系统，我并不关心访问者是人类还是机器，因为在验证你提交的密码之前，我先验证你的工作量，也可以说是“浪费”你的算力，对于人类而言，反正这个工作是计算机进行，用户无需干预，只需等一小会即可，反观机器人，为了爆破密码，每次提交不同的密码之前，都要花费一定时间解决pow难题，这么算下来，爆破速度和人类手工爆破速度一致，为了获取真实密码，花费的时间成本太大，那还不如不爆破了。</p>
<p>什么，你说美国人想用混合精度高达每秒1,000,000,000,000,000,000次的目前超算能力排名第一的超计算机Frontier来爆破我的博客系统管理员密码？</p>
<p>从这个意义上来说，基于pow的也算得上是一个称职的验证码系统，因为的确达到了减缓机器人爆破的目的，只不过这个验证码是一个哈希值，是由计算机去计算的，无需用户干预，提升了用户体验。</p>
</blockquote>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>为了实现这个过程，需要客户端和服务端共同努力，整个流程如下图：</p>
<p><img src="https://cdn.yalexin.top/image-20230619112607571.png" alt="image-20230619112607571"></p>
<p>首先客户端要请求服务端，服务端随机生成前缀字符串<code>prefix</code>，将该字符串连同困难度<code>difficult</code>返回给客户端，客户端以迭代方式计算后缀，使得前后缀的哈希值符合条件，然后将后缀以及对应的哈希值提交给服务端，服务端再结合之前生成的前缀，验证这个后缀是否符合条件，一方面,如果符合条件，在session中标记,然后通知客户端可以提交密码，收到用户提交的密码时候,第一件事就是判断session中有无标记,避免用户不进行pow而直接提交密码;另一方面,如果验证不通过,则重新生成一个随机前缀，重复上述步骤.</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>目前客户端实现已开源至<a href="https://github.com/YaleXin/pow-captcha-js" target="_blank" rel="noopener">GitHub</a></p>
<p>可以根据下面的步骤使用:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/YaleXin/pow-captcha-js</span><br><span class="line">npm install</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<p>运行上述命令后,将会在<code>dist</code>目录下产生<code>pow-captcha-js.js</code>,将其复制到你需要的项目中即可,例如在Vue项目中,将其复制到目录<code>static/js/</code>,在代码中使用:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">import</span> &#123; Captcha &#125; <span class="keyword">from</span> <span class="string">"../../static/js/pow-captcha-js.js"</span></span><br><span class="line">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">      mounted() &#123;</span><br><span class="line">        <span class="keyword">this</span>.pow();</span><br><span class="line">      &#125;,</span><br><span class="line">      methods: &#123;</span><br><span class="line">      	pow() &#123;</span><br><span class="line">		  <span class="keyword">const</span> CONFIG_URL = <span class="string">'/api/admin/powConfig'</span>;</span><br><span class="line">          <span class="keyword">const</span> VERIFY_URL = <span class="string">'/api/admin/powVerify'</span></span><br><span class="line">          <span class="keyword">const</span> cpt = <span class="keyword">new</span> Captcha();</span><br><span class="line">          cpt.start(CONFIG_URL, VERIFY_URL).then(<span class="function"><span class="params">resobj</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'obj==&gt;'</span>, resobj);</span><br><span class="line">          &#125;).catch(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'pow e =&gt;'</span>, e);</span><br><span class="line">          &#125;)</span><br><span class="line">    	&#125;,</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>服务端必须实现两个接口:<code>CONFIG_URL</code>和<code>VERIFY_URL</code></p>
<p>在<code>CONFIG_URL</code>接口中,需要返回一个json数据,格式如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"difficulty"</span>:<span class="number">5</span>,</span><br><span class="line">    <span class="attr">"prefix"</span>:<span class="string">"Ve03Plle"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>VERIFY_URL</code>接口中,需要接收一个json数据(该数据由客户端以post方式提交),格式如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"md5Str"</span>:<span class="string">"00000119414c7a8c9678b96fbc4954be"</span>,</span><br><span class="line">        <span class="attr">"paddingNum"</span>:<span class="number">300880</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>paddingNum</code>即用户暴力迭代寻找到的后缀.</p>
<p>服务端要在这个接口中完成两个验证:</p>
<ol>
<li><code>md5Str==md5(prefix+paddingNum)</code></li>
<li><code>md5Str</code>前导零个数至少是 <code>difficulty</code></li>
</ol>
<p><code>difficulty</code> 和 <code>prefix</code> 对应于在接口<code>CONFIG_URL</code>中返回的内容.</p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p><code>Captcha.start()</code>会返回一个promise对象,如果通过验证,则会在<code>then</code>中返回一个对象<code>resobj</code>,该对象内容如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    verify: <span class="literal">true</span>, </span><br><span class="line">    tryServerCnt: tryServerCnt,</span><br><span class="line">    totalTryCnt: totalTryCnt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">verify</td>
<td align="center">服务端验证结果</td>
</tr>
<tr>
<td align="center">totalTryCnt</td>
<td align="center">总迭代次数</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前前端代码是单线程的,未来将考虑使用多线程.</p>
<p>其实我一开始就是以多线程的方式是写的,当时是用<code>worker_threads</code>,但是打包过程发现我才发现这包是在<code>nodejs</code>环境下的,在浏览器环境下无法执行,只好换成<code>Web Worker</code>的方式,但是这种方式对于传入的脚本有同源限制,打包后总是提示找不到对应的<code>worker.js</code>.最后不得不使用单线程的方式.</p>
<p>未来看一下怎么用借助<code>webpack</code> 的<code>worker loader</code>解决使用<code>worker</code>遇到的问题.</p>
<hr>
<ul>
<li>2023-06-20更新：✔ 已借助webpack完成多线程重塑代码</li>
</ul>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by YaleXin, licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0" target="_blank" rel="noopener">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/前端/" class="tag">#前端</a><a href="/tags/PoW/" class="tag">#PoW</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/07/31/CS-APP3e%E7%B3%BB%E5%88%97%E5%AE%9E%E9%AA%8C%E9%A2%84%E5%91%8A/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">CS:APP3e系列实验预告</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/05/04/%E5%85%B3%E4%BA%8E%E4%BA%8C%E5%88%86%E7%AE%97%E6%B3%95%E4%B8%AD%E7%9A%84%E8%BE%B9%E7%95%8C%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">关于二分算法中的边界问题的思考</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/projects" class="item">Projects</a>
                
                <a href="/resume" class="item">Resume</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a href="https://github.com/MrWillCom/rsa-cli" target="_blank" rel="noopener" class="item">RSA CLI</a>
                
                <a href="https://github.com/MrWillCom/hexo-theme-cupertino" target="_blank" rel="noopener" class="item">Hexo Theme Cupertino</a>
                
                <a href="https://github.com/MrWillCom/a-calendar" target="_blank" rel="noopener" class="item">A Calendar</a>
                
                <a href="https://github.com/MrWillCom/auto-mirroring-bucket" target="_blank" rel="noopener" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a href="https://github.com/MrWillCom" target="_blank" rel="noopener" class="item">GitHub</a>
                
                <a href="https://codepen.io/mrwillcom" target="_blank" rel="noopener" class="item">CodePen</a>
                
                <a href="https://www.patreon.com/MrWillCom" target="_blank" rel="noopener" class="item">Patreon</a>
                
                <a href="https://noc.social/@MrWillCom" target="_blank" rel="noopener" class="item">Mastodon</a>
                
                <a href="https://discord.gg/UKuFDjcfY8" target="_blank" rel="noopener" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 YaleXin<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>