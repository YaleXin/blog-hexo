<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico"><link rel="mask-icon" href="/images/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"yalexin.gitee.io",root:"/",scheme:"Gemini",version:"7.7.1",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="总体要求实现一个小小的shell程序，涉及进程调度，信号处理，并发处理的知识，需要掌握教材第8章。 话不多说，打开电脑，带上键盘，开启实验！"><meta property="og:type" content="article"><meta property="og:title" content="CS:APP-Shell Lab"><meta property="og:url" content="https://yalexin.gitee.io/2023/11/14/CS-APP-Shell-Lab/index.html"><meta property="og:site_name" content="黄阿信"><meta property="og:description" content="总体要求实现一个小小的shell程序，涉及进程调度，信号处理，并发处理的知识，需要掌握教材第8章。 话不多说，打开电脑，带上键盘，开启实验！"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-11-14T01:40:12.000Z"><meta property="article:modified_time" content="2023-11-14T01:42:34.863Z"><meta property="article:author" content="YaleXin"><meta property="article:tag" content="信号"><meta property="article:tag" content="任务调度"><meta property="article:tag" content="并发"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://yalexin.gitee.io/2023/11/14/CS-APP-Shell-Lab/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>CS:APP-Shell Lab | 黄阿信</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">黄阿信</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">要么改变世界，要么适应世界。</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签<span class="badge">120</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档<span class="badge">127</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-fw fa-book"></i> 留言板</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i> 友链</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yalexin.gitee.io/2023/11/14/CS-APP-Shell-Lab/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/cat_mouse.jpg"><meta itemprop="name" content="YaleXin"><meta itemprop="description" content="学渣一枚"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="黄阿信"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> CS:APP-Shell Lab</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-14 09:40:12 / 修改时间：09:42:34" itemprop="dateCreated datePublished" datetime="2023-11-14T09:40:12+08:00">2023-11-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">教程</span></a></span></span><span id="/2023/11/14/CS-APP-Shell-Lab/" class="post-meta-item leancloud_visitors" data-flag-title="CS:APP-Shell Lab" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>13k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>12 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="总体要求"><a href="#总体要求" class="headerlink" title="总体要求"></a>总体要求</h2><p>实现一个小小的<code>shell</code>程序，涉及进程调度，信号处理，并发处理的知识，需要掌握教材第8章。</p><p>话不多说，打开电脑，带上键盘，开启实验！<a id="more"></a></p><h2 id="一些说明"><a href="#一些说明" class="headerlink" title="一些说明"></a>一些说明</h2><p>源文件已经帮我们实现了一部分函数，需要我们完成剩余的函数：</p><ul><li><p><code>eval</code>：主要用于解析和解释命令行（70行左右）</p></li><li><p><code>builtin_cmd</code>：识别并解释内置命令：quit、fg、bg 和 jobs（25行左右）</p></li><li><p><code>do_bgfg</code>: 实现内置命令<code>bg</code>和<code>fg</code>. [50 行左右]</p></li><li><p><code>waitfg</code>: 等待前台任务完成. [20 行左右]</p></li><li><p><code>sigchld_handler</code>: 捕捉SIGCHILD 信号. 80 行左右]</p></li><li><p><code>sigint_handler</code>: 捕捉SIGINT (ctrl-c) 信号. [15 行左右]</p></li><li><p><code>sigtstp_handler</code>: 捕捉SIGTSTP (ctrl-z) 信号. [15 行左右]</p></li></ul><p>对于输入到命令行中的字符串，第一个单词要么是内置命令，要么是可执行文件路径。</p><p>如果是内置命令，则在当前进程中执行；</p><p>如果是可执行文件路径，则forks一个子进程，并在子进程中执行相应程序。</p><p>我们称解释该字符串过程创造的子进程称为作业job，通常一个作业由多个子进程组成。</p><p>如果字符串以<code>&amp;</code>结束，则该作业以后台方式运行，意味着shell程序不等待作业结束，而直接打印提示符等待输入下一条命令。</p><p>否则，该作业以前台方式运行，等待该命令执行完毕，再打印提示符等待输入下一条命令。</p><p>Unix shell 支持作业控制概念，允许我们将作业在前台后台之间切换，改变进程状态（运行，停止，终止）。</p><p>输入CTRL-C将发送SIGINT信号到每一个前台作业中，默认情况下，收到SIGINT信号的进程会被终止。</p><p>输入CTRL-Z将发送SIGTSTP信号到每一个前台作业中，默认情况下，收到SIGTSTP信号的进程会被停止，停止状态下，可以接收来自其他进程的SIGCONT信号，从而继续运行。</p><p>内置命令：</p><ul><li>jobs：列出正在运行和停止的后台作业</li><li>bg<job>：将一个停止状态的后台作业变为运行的后台作业</job></li><li>fg<job>：将一个停止状态或者运行的后台作业变为运行的前台作业</job></li><li>kill<job>：终止作业</job></li></ul><h2 id="tsh"><a href="#tsh" class="headerlink" title="tsh"></a>tsh</h2><ul><li><p>提示符为”tsh&gt; “</p></li><li><p>当输入的第一个单词是内置命令时，tsh应该立即执行并等待下一个命令输入，否则把第一个单词作为可执行文件路径，并在初始化后的子进程中加载并运行可执行文件</p></li><li><p>tsh不必支持管道（|）或者I/O（&gt;和&lt;）</p></li><li><p>输入CTRL-C（CTRL-Z）时应发送SIGINT（SIGTSTP）信号到当前前台作业以及该作业的所有子进程（例如它fork出来的子进程），如果没有前台作业，则不会造成任何影响。</p></li><li><p>如果字符串以<code>&amp;</code>结束，则该作业以后台方式运行，否则，在前台运行</p></li><li><p>每个作业，可以被进程ID或者作业ID识别。“%5”表示作业ID，“5”表示进程ID</p></li><li><p>tsh需要支持以下命令：</p><ul><li>quit：退出shell</li><li>jobs：列出所有后台作业</li><li>bg<job>：发送SIGCONT信号，重启并在后台运行作业，<job>可以是PID（进程ID）或者JID（作业ID）</job></job></li><li>fg<job>：发送SIGCONT信号，重启并在前台运行作业，<job>可以是PID（进程ID）或者JID（作业ID）</job></job></li></ul></li><li><p>tsh应该回收所有僵尸子进程，如果有作业因为接收到一个它没有捕捉到的信号而终止，那么 tsh 就应该识别这一事件，并打印一条包含该作业 PID 和违规信号描述的信息。</p></li></ul><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="01"><a href="#01" class="headerlink" title="01"></a>01</h3><p>二话不说，参照P525即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* argv[MAXARGS];</span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> bg;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 忽略空白行</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不是内置命令</span></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 子进程</span></span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s: Command not found.\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 父进程等待前台作业停止</span></span><br><span class="line">        <span class="keyword">if</span> (!bg) &#123;</span><br><span class="line">            <span class="keyword">int</span> status;</span><br><span class="line">            <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                unix_error(<span class="string">"waitfg: waipid error"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d %s"</span>, pid, cmdline);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make rtest01</span><br><span class="line">make test01</span><br></pre></td></tr></table></figure><h3 id="02"><a href="#02" class="headerlink" title="02"></a>02</h3><p>在原先的基础上增加对内置命令的识别，我们参照P525的，修改下面的函数即可：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"jobs"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        listjobs(jobs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"bg"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"kill"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"&amp;"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"quit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make rtest02</span><br><span class="line">make test02</span><br></pre></td></tr></table></figure><h3 id="03"><a href="#03" class="headerlink" title="03"></a>03</h3><p>做完02的测试，实际上03的也通过了</p><h3 id="04"><a href="#04" class="headerlink" title="04"></a>04</h3><p>运行测试，我们发现，不一样的地方在于输出不同，我们要先输出当前作业的ID，再输出进程ID，再输出该命令。</p><p>主要修改eval函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父进程等待前台作业停止</span></span><br><span class="line"><span class="keyword">if</span> (!bg) &#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        unix_error(<span class="string">"waitfg: waipid error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, pid2jid(pid),pid, cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是我们发现，我们的输出jid是0，而<code>tshref</code>输出是1，这我们到后面再解决（这涉及添加作业到全局作业列表中。）</p><h3 id="05"><a href="#05" class="headerlink" title="05"></a>05</h3><p>在这个测试中，我们主要实现对全局作业列表的修改。</p><p>我们先修改eval函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">addjob(jobs, pid, bg ? BG : FG ,cmdline);</span><br><span class="line">   <span class="comment">// 父进程等待前台作业停止</span></span><br><span class="line">   <span class="keyword">if</span> (!bg) &#123;</span><br><span class="line">       <span class="keyword">int</span> status;</span><br><span class="line">       <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           unix_error(<span class="string">"waitfg: waipid error"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>当我们手动测试的时候，即：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">./tsh</span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash">  ./myspin 20 &amp;</span></span><br><span class="line">[1] (835379)  ./myspin 20 &amp;</span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash"> ./myspin 20 &amp;</span></span><br><span class="line">[2] (835441) ./myspin 20 &amp;</span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash"> <span class="built_in">jobs</span></span></span><br><span class="line">[1] (835379) Running  ./myspin 20 &amp;</span><br><span class="line">[2] (835441) Running ./myspin 20 &amp;</span><br></pre></td></tr></table></figure><p>我们发现，我们是可以正常运行的，但是当我们使用下面的方式进行测试的时候，我们发现我们的输出并不一致：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">make test05</span><br><span class="line">./sdriver.pl -t trace05.txt -s ./tsh -a "-p"</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> trace05.txt - Process <span class="built_in">jobs</span> <span class="built_in">builtin</span> <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash"> ./myspin 2 &amp;</span></span><br><span class="line">[2] (837522) ./myspin 2 &amp;</span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash"> ./myspin 3 &amp;</span></span><br><span class="line">[4] (837524) ./myspin 3 &amp;</span><br><span class="line"><span class="meta">tsh&gt;</span><span class="bash"> <span class="built_in">jobs</span></span></span><br><span class="line">[1] (837521) Foreground /bin/echo -e tsh&gt; ./myspin 2 \046</span><br><span class="line">[2] (837522) Running ./myspin 2 &amp;</span><br><span class="line">[3] (837523) Foreground /bin/echo -e tsh&gt; ./myspin 3 \046</span><br><span class="line">[4] (837524) Running ./myspin 3 &amp;</span><br><span class="line">[5] (837525) Foreground /bin/echo tsh&gt; jobs</span><br></pre></td></tr></table></figure><p>这是因为我们没有及时把已完成的作业从作业列表中删除，这个我们放到后面再解决。</p><h3 id="06"><a href="#06" class="headerlink" title="06"></a>06</h3><p>在这个测试中， 要求我们完成对<code>SIGINT</code>信号的处理，即在<code>sigint_handler</code>函数中，我们要把<code>SIGINT</code>信号发送到整个前台进程组，参考教材和实验说明，我们应该使用<code>-pid</code>，同时在创建子进程后，我们应该调用<code>setpgid(0, 0)</code>设置当前进程的进程组ID为当前进程ID。</p><p>默认情况下，一个进程收到<code>SIGINT</code>时，会被终止，而每当子进程终止时候，会触发<code>sigchld_handler</code>函数，我们这时候需要进一步完善该函数。在该函数中，我们要区分是由于正常结束而触发事件，还是其他信号而触发的事件。</p><p>此外，为了顺便将已完成的前台作业从作业列表中删除，我们要修改eval函数，我们之前在判断是前台作业后，使用的是<code>waitpid</code>，但是我们为了能够在<code>sigchld_handler</code>函数中，回收子进程，我们在<code>sigchld_handler</code>函数中使用了<code>waitpid</code>,结合实验说明，在判断是前台作业后，我们应该调用<code>waitfg</code>，而该函数中，我们使用<code>sleep</code>函数将父进程挂起一段时间（只要前台作业没结束）。</p><p>还有最重要的一点就是，涉及全局变量修改的地方，需要避免出现竞争情况（参考教材P541），例如我们得确保addjob在deletejob之前。</p><p>这次改动地方比较多：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-168</span>,<span class="number">6</span> +<span class="number">168</span>,<span class="number">8</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> bg;</span><br><span class="line">     <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">+    <span class="keyword">sigset_t</span> mask_all,mask_one,prev_one;</span><br><span class="line">+</span><br><span class="line">     <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">     bg = parseline(buf, argv);</span><br><span class="line">     <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">@@ <span class="number">-176</span>,<span class="number">20</span> +<span class="number">178</span>,<span class="number">34</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 如果不是内置命令</span></span><br><span class="line">     <span class="keyword">if</span> (!builtin_cmd(argv)) &#123;</span><br><span class="line">+        <span class="comment">// 将每个信号添加到set中</span></span><br><span class="line">+        sigfillset(&amp;mask_all);</span><br><span class="line">+        <span class="comment">// 初始化空集合</span></span><br><span class="line">+        sigemptyset(&amp;mask_one);</span><br><span class="line">+        <span class="comment">// 将 SIGCHLD 信号添加到集合中</span></span><br><span class="line">+        sigaddset(&amp;mask_one, SIGCHLD);</span><br><span class="line">+        <span class="comment">// 暂时阻塞 SIGCHLD 信号，避免由于操作系统调用的原因，导致addjob在deletejob之后</span></span><br><span class="line">+        sigprocmask(SIG_BLOCK, &amp;mask_one, &amp;prev_one);</span><br><span class="line">+</span><br><span class="line">         <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// 子进程</span></span><br><span class="line">+            <span class="comment">// 恢复信号集合，解除对 SIGCHLD 的阻塞（子进程继承了父进程的阻塞设置，因此它无法接收子进程的信号，所以我们必须解除阻塞）</span></span><br><span class="line">+            sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">+            setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">             <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="built_in">printf</span>(<span class="string">"%s: Command not found.\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                 <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">+        <span class="comment">// 阻塞SIGCHLD</span></span><br><span class="line">+        sigprocmask(SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">+</span><br><span class="line">         addjob(jobs, pid, bg ? BG : FG ,cmdline);</span><br><span class="line">+        <span class="comment">// 解除阻塞SIGCHLD</span></span><br><span class="line">+        sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">         <span class="comment">// 父进程等待前台作业停止</span></span><br><span class="line">         <span class="keyword">if</span> (!bg) &#123;</span><br><span class="line">-            <span class="keyword">int</span> status;</span><br><span class="line">-            <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">-                unix_error(<span class="string">"waitfg: waipid error"</span>);</span><br><span class="line">-            &#125;</span><br><span class="line">+            waitfg(pid);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, pid2jid(pid),pid, cmdline);</span><br><span class="line">@@ <span class="number">-292</span>,<span class="number">6</span> +<span class="number">308</span>,<span class="number">10</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  * waitfg - Block until <span class="built_in">process</span> pid is no longer the foreground <span class="built_in">process</span></span><br><span class="line">  */</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">while</span>(fgpid(jobs))&#123;</span><br><span class="line">+        <span class="comment">// 挂起 500 微妙</span></span><br><span class="line">+        usleep(<span class="number">500</span>);</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">@@ <span class="number">-307</span>,<span class="number">6</span> +<span class="number">327</span>,<span class="number">38</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">   *     currently <span class="built_in">running</span> children to <span class="built_in">terminate</span>.</span><br><span class="line">   */</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">+    <span class="keyword">sigset_t</span> mask_all,prev_all;</span><br><span class="line">+    sigfillset(&amp;mask_all);</span><br><span class="line">+    <span class="keyword">int</span> status;</span><br><span class="line">+    <span class="keyword">pid_t</span> pid;</span><br><span class="line">+</span><br><span class="line">+    <span class="comment">// tsh进程等待它的所有进程，采用非阻塞的方式</span></span><br><span class="line">+    <span class="keyword">while</span>((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">+        <span class="comment">// 如果是正常结束的进程</span></span><br><span class="line">+        <span class="keyword">if</span>(WIFEXITED(status))&#123;</span><br><span class="line">+</span><br><span class="line">+            sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">+            deletejob(jobs, pid);</span><br><span class="line">+            sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(WIFSIGNALED(status))&#123;</span><br><span class="line">+</span><br><span class="line">+            <span class="comment">// 如果是通过被信号终止的进程</span></span><br><span class="line">+            struct <span class="keyword">job_t</span>* current_job = getjobpid(jobs, pid);</span><br><span class="line">+            <span class="keyword">int</span> jid = current_job-&gt;jid;</span><br><span class="line">+            sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">+            <span class="comment">// 删除该作业</span></span><br><span class="line">+            <span class="keyword">if</span>(deletejob(jobs, pid))&#123;</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) terminated by signal %d\n"</span>, jid, pid, WTERMSIG(status));</span><br><span class="line">+            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">+                app_error(<span class="string">"Job terminated failed\n"</span>);</span><br><span class="line">+            &#125;</span><br><span class="line">+            sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+            <span class="built_in">printf</span>(<span class="string">"DEBUG (%d) other situation %d\n"</span>, pid, sig);</span><br><span class="line">+        &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+    errno = olderrno;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">@@ <span class="number">-316</span>,<span class="number">6</span> +<span class="number">368</span>,<span class="number">18</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">  *    to the foreground job.</span><br><span class="line">  */</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">+    <span class="keyword">sigset_t</span> mask, prev;</span><br><span class="line">+    sigfillset(&amp;mask);</span><br><span class="line">+    sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">+    <span class="comment">// 获取当前前台作业的进程ID</span></span><br><span class="line">+    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">+    sigprocmask(SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">+    <span class="comment">// 不为零时，代表存在前台作业</span></span><br><span class="line">+    <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">+        kill(-pid, sig);</span><br><span class="line">+    &#125;</span><br><span class="line">+    errno = olderrno;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="07"><a href="#07" class="headerlink" title="07"></a>07</h3><p>这一部分主要测试我们是否能够在输入ctrl-c时候，只把该信号发送给前台作业，而不影响后台作业，即我们先创建一个在作业在后台运行，然后再创建一个前台作业，再输入ctrl-c，此时前台作业应该被停止，当我们输入<code>jobs</code>时候，只会一个后台作业（前提是我们要迅速输入<code>jobs</code>，防止后台作业完成了）。</p><p>如果<code>06</code>的代码修改没问题的话，这一个测试是可以直接过的。</p><h3 id="08"><a href="#08" class="headerlink" title="08"></a>08</h3><p>这一部分主要是测试我们是否能够在输入ctrl-z时候，只把该信号发送给前台作业，而不影响后台作业。</p><p>这个也没什么难度，参照着对ctrl-c的处理方式即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-354</span>,<span class="number">6</span> +<span class="number">354</span>,<span class="number">14</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">                 app_error(<span class="string">"Job terminated failed\n"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFSTOPPED(status))&#123;</span><br><span class="line">+            struct <span class="keyword">job_t</span>* current_job = getjobpid(jobs, pid);</span><br><span class="line">+            <span class="keyword">int</span> jid = current_job-&gt;jid;</span><br><span class="line">+            sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">+            <span class="comment">// 修改该作业为停止状态</span></span><br><span class="line">+            current_job-&gt;state = ST;</span><br><span class="line">+            sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+            <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) stopped by signal %d\n"</span>, jid, pid, WSTOPSIG(status));</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"DEBUG (%d) other situation %d\n"</span>, pid, sig);</span><br><span class="line">         &#125;</span><br><span class="line">@@ <span class="number">-389</span>,<span class="number">6</span> +<span class="number">397</span>,<span class="number">18</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">  *     foreground job by sending it a SIGTSTP.</span><br><span class="line">  */</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">+    <span class="keyword">sigset_t</span> mask, prev;</span><br><span class="line">+    sigfillset(&amp;mask);</span><br><span class="line">+    sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">+    <span class="comment">// 获取当前前台作业的进程ID</span></span><br><span class="line">+    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">+    sigprocmask(SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">+    <span class="comment">// 不为零时，代表存在前台作业</span></span><br><span class="line">+    <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">+        kill(-pid, sig);</span><br><span class="line">+    &#125;</span><br><span class="line">+    errno = olderrno;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="09"><a href="#09" class="headerlink" title="09"></a>09</h3><p>这一部分主要是测试我们是否处理内置命令<code>bg</code>,该命令发送SIGCONT信号，重启并在后台运行作业。因此我们要完善<code>do_bgfg</code>函数，在这个函数中，我们要先判断是<code>bg</code>还是<code>fg</code>，再判断该作业是由<code>jid</code>还是<code>pid</code>给出</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-85</span>,<span class="number">6</span> +<span class="number">85</span>,<span class="number">9</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">app_error</span><span class="params">(<span class="keyword">char</span>* msg)</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">typedef</span> <span class="keyword">void</span> <span class="title">handler_t</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">handler_t</span>* <span class="title">Signal</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">handler_t</span>* handler)</span></span>;</span><br><span class="line"></span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">int</span> <span class="title">string2num</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> start)</span></span>;</span><br><span class="line">+</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * main - The shell's main routine</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">@@ <span class="number">-297</span>,<span class="number">10</span> +<span class="number">300</span>,<span class="number">46</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">+<span class="function"><span class="keyword">int</span> <span class="title">string2num</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> start)</span></span>&#123;</span><br><span class="line">+    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">+    <span class="keyword">for</span>(<span class="keyword">int</span> i = start; str[i] != <span class="string">'\0'</span>; i++)&#123;</span><br><span class="line">+        ans = ans * <span class="number">10</span> + str[i] - <span class="string">'0'</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="keyword">return</span> ans;</span><br><span class="line">+&#125;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">sigset_t</span> mask_all,prev_all;</span><br><span class="line">+    sigfillset(&amp;mask_all);</span><br><span class="line">+    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"bg"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">+        <span class="comment">// bg 命令</span></span><br><span class="line">+        <span class="keyword">int</span> jid;</span><br><span class="line">+        <span class="keyword">pid_t</span> pid;</span><br><span class="line">+        <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">select_job</span> = <span class="title">NULL</span>;</span></span><br><span class="line">+        <span class="comment">// 如果是以 jid 方式标识</span></span><br><span class="line">+        <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>)&#123;</span><br><span class="line">+            jid = string2num(argv[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">+            select_job = getjobjid(jobs, jid);</span><br><span class="line">+            pid = select_job-&gt;pid;</span><br><span class="line">+        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">+            <span class="comment">// 如果是以 pid 方式标识</span></span><br><span class="line">+            pid = string2num(argv[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">+            select_job = getjobpid(jobs, pid);</span><br><span class="line">+            jid = select_job-&gt;jid;</span><br><span class="line">+        &#125;</span><br><span class="line">+        sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">+        <span class="comment">// 修改job状态为后台运行</span></span><br><span class="line">+        select_job-&gt;state = BG;</span><br><span class="line">+        sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+        kill(-pid, SIGCONT);</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, select_job-&gt;jid, select_job-&gt;pid, select_job-&gt;cmdline);</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">+        <span class="comment">// fg 命令</span></span><br><span class="line">+    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">+        app_error(<span class="string">"not bg or fg command\n"</span>);</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="10"><a href="#10" class="headerlink" title="10"></a>10</h3><p>这一部分主要是测试我们是否处理内置命令<code>bg</code>,该命令发送SIGCONT信号，重启并在前台运行作业。参照09即可：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-337</span>,<span class="number">6</span> +<span class="number">337</span>,<span class="number">26</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, select_job-&gt;jid, select_job-&gt;pid, select_job-&gt;cmdline);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">         <span class="comment">// fg 命令</span></span><br><span class="line">+        <span class="keyword">int</span> jid;</span><br><span class="line">+        <span class="keyword">pid_t</span> pid;</span><br><span class="line">+        <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">select_job</span> = <span class="title">NULL</span>;</span></span><br><span class="line">+        <span class="comment">// 如果是以 jid 方式标识</span></span><br><span class="line">+        <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>)&#123;</span><br><span class="line">+            jid = string2num(argv[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">+            select_job = getjobjid(jobs, jid);</span><br><span class="line">+            pid = select_job-&gt;pid;</span><br><span class="line">+        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">+            <span class="comment">// 如果是以 pid 方式标识</span></span><br><span class="line">+            pid = string2num(argv[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">+            select_job = getjobpid(jobs, pid);</span><br><span class="line">+            jid = select_job-&gt;jid;</span><br><span class="line">+        &#125;</span><br><span class="line">+        sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">+        <span class="comment">// 修改job状态为前台运行</span></span><br><span class="line">+        select_job-&gt;state = FG;</span><br><span class="line">+        sigprocmask(SIG_SETMASK,&amp;prev_all,<span class="literal">NULL</span>);</span><br><span class="line">+        kill(-pid, SIGCONT);</span><br><span class="line">+        waitfg(pid);</span><br><span class="line">     &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">         app_error(<span class="string">"not bg or fg command\n"</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><h3 id="11"><a href="#11" class="headerlink" title="11"></a>11</h3><p>在这个测试中， 调用<code>mysplit</code>，而该程序运行后会创建若干个进程，然后测试<code>SIGINT</code>信号能否传播到前台进程组中的每个进程，我们观察下面的输出，只要除了进程ID不一样，其他都一样的话，则算满足：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make rtest11</span><br><span class="line">make test11</span><br></pre></td></tr></table></figure><h3 id="12"><a href="#12" class="headerlink" title="12"></a>12</h3><p>同上，只不过测试的是SIGTSTP</p><h3 id="13"><a href="#13" class="headerlink" title="13"></a>13</h3><p>同上，只不过测试的是Restart ，即<code>fg</code>命令</p><h3 id="14"><a href="#14" class="headerlink" title="14"></a>14</h3><p>在这个测试中，主要是针对一些错误情况，例如输入的命令不符合标准，我们只要对原先的程序进行修改即可。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-311</span>,<span class="number">6</span> +<span class="number">311</span>,<span class="number">15</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">string2num</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> start)</span></span>&#123;</span><br><span class="line">  * do_bgfg - Execute the builtin bg <span class="keyword">and</span> fg commands</span><br><span class="line">  */</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">if</span>(argv[<span class="number">1</span>] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"%s command requires PID or %%jobid argument\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">+        <span class="keyword">return</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="comment">// bg 或者 fg 后面的参数既不是数字也不是%</span></span><br><span class="line">+    <span class="keyword">if</span> ( (argv[<span class="number">1</span>][<span class="number">0</span>] &lt; <span class="string">'0'</span> || argv[<span class="number">1</span>][<span class="number">0</span>] &gt; <span class="string">'9'</span>)  &amp;&amp; argv[<span class="number">1</span>][<span class="number">0</span>] != <span class="string">'%'</span>) &#123;</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">"%s: argument must be a PID or %%jobid\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">+        <span class="keyword">return</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">sigset_t</span> mask_all,prev_all;</span><br><span class="line">     sigfillset(&amp;mask_all);</span><br><span class="line">     <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"bg"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">@@ <span class="number">-322</span>,<span class="number">11</span> +<span class="number">331</span>,<span class="number">19</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>)&#123;</span><br><span class="line">             jid = string2num(argv[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">             select_job = getjobjid(jobs, jid);</span><br><span class="line">+            <span class="keyword">if</span>(select_job == <span class="literal">NULL</span>)&#123;</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"%s: No such job\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">+                <span class="keyword">return</span>;</span><br><span class="line">+            &#125;</span><br><span class="line">             pid = select_job-&gt;pid;</span><br><span class="line">         &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="comment">// 如果是以 pid 方式标识</span></span><br><span class="line">             pid = string2num(argv[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">             select_job = getjobpid(jobs, pid);</span><br><span class="line">+            <span class="keyword">if</span> (select_job == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"(%s): No such process\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">+                <span class="keyword">return</span>;</span><br><span class="line">+            &#125;</span><br><span class="line">             jid = select_job-&gt;jid;</span><br><span class="line">         &#125;</span><br><span class="line">         sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br><span class="line">@@ <span class="number">-344</span>,<span class="number">11</span> +<span class="number">361</span>,<span class="number">19</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>)&#123;</span><br><span class="line">             jid = string2num(argv[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">             select_job = getjobjid(jobs, jid);</span><br><span class="line">+            <span class="keyword">if</span>(select_job == <span class="literal">NULL</span>)&#123;</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"%s: No such job\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">+                <span class="keyword">return</span>;</span><br><span class="line">+            &#125;</span><br><span class="line">             pid = select_job-&gt;pid;</span><br><span class="line">         &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="comment">// 如果是以 pid 方式标识</span></span><br><span class="line">             pid = string2num(argv[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">             select_job = getjobpid(jobs, pid);</span><br><span class="line">+            <span class="keyword">if</span> (select_job == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"(%s): No such process\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">+                <span class="keyword">return</span>;</span><br><span class="line">+            &#125;</span><br><span class="line">             jid = select_job-&gt;jid;</span><br><span class="line">         &#125;</span><br><span class="line">         sigprocmask(SIG_BLOCK,&amp;mask_all,&amp;prev_all);</span><br></pre></td></tr></table></figure><h3 id="15"><a href="#15" class="headerlink" title="15"></a>15</h3><p>在这个测试中，就是整合一起测试，我突然发现，命令找不到时候，输出语句，多了个字符，修改一下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--- a/shell/tsh.c</span><br><span class="line">+++ b/shell/tsh.c</span><br><span class="line">@@ <span class="number">-196</span>,<span class="number">7</span> +<span class="number">196</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line">             sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">             setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">             <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">-                <span class="built_in">printf</span>(<span class="string">"%s: Command not found.\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">+                <span class="built_in">printf</span>(<span class="string">"%s: Command not found\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                 <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><h3 id="16"><a href="#16" class="headerlink" title="16"></a>16</h3><p>在这个测试中，检查我们的<code>tsh</code>程序能否可以正确处理来自其他进程的<code>SIGSTP</code>和<code>SIGINT</code>信号</p><h2 id="完成代码"><a href="#完成代码" class="headerlink" title="完成代码"></a>完成代码</h2><p>请移步<a href="https://github.com/YaleXin/CS-APP3e-Labs/blob/main/Shell-Lab/tsh.c" target="_blank" rel="noopener">【仓库】</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本实验涉及内容比较多，建议先看几遍教材的第8章，然后再做实验，对照着书来做。</p></div><div class="reward-container"><div>假如对您有所帮助，那就请我喝咖啡吧~~</div> <button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="/images/WeChat.png" alt="YaleXin 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="/images/Alipay.jpg" alt="YaleXin 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E4%BF%A1%E5%8F%B7/" rel="tag"><i class="fa fa-tag"></i> 信号</a><a href="/tags/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" rel="tag"><i class="fa fa-tag"></i> 任务调度</a><a href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> 并发</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2023/10/03/CS-APP-Cache-Lab/" rel="prev" title="CS:APP-Cache Lab"><i class="fa fa-chevron-left"></i> CS:APP-Cache Lab</a></div><div class="post-nav-item"> <a href="/2023/12/01/CS-APP-Malloc-Lab/" rel="next" title="CS:APP-Malloc Lab">CS:APP-Malloc Lab<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div><div><div style="text-align:center;color:#ccc;font-size:14px">------ 文章结束------</div></div></div></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#总体要求"><span class="nav-number">1.</span> <span class="nav-text">总体要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一些说明"><span class="nav-number">2.</span> <span class="nav-text">一些说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tsh"><span class="nav-number">3.</span> <span class="nav-text">tsh</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现"><span class="nav-number">4.</span> <span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#01"><span class="nav-number">4.1.</span> <span class="nav-text">01</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#02"><span class="nav-number">4.2.</span> <span class="nav-text">02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#03"><span class="nav-number">4.3.</span> <span class="nav-text">03</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#04"><span class="nav-number">4.4.</span> <span class="nav-text">04</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#05"><span class="nav-number">4.5.</span> <span class="nav-text">05</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#06"><span class="nav-number">4.6.</span> <span class="nav-text">06</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#07"><span class="nav-number">4.7.</span> <span class="nav-text">07</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#08"><span class="nav-number">4.8.</span> <span class="nav-text">08</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#09"><span class="nav-number">4.9.</span> <span class="nav-text">09</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10"><span class="nav-number">4.10.</span> <span class="nav-text">10</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11"><span class="nav-number">4.11.</span> <span class="nav-text">11</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12"><span class="nav-number">4.12.</span> <span class="nav-text">12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13"><span class="nav-number">4.13.</span> <span class="nav-text">13</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14"><span class="nav-number">4.14.</span> <span class="nav-text">14</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15"><span class="nav-number">4.15.</span> <span class="nav-text">15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16"><span class="nav-number">4.16.</span> <span class="nav-text">16</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完成代码"><span class="nav-number">5.</span> <span class="nav-text">完成代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="YaleXin" src="/uploads/cat_mouse.jpg"><p class="site-author-name" itemprop="name">YaleXin</p><div class="site-description" itemprop="description">学渣一枚</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">127</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">120</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2020 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-fas fa-heartbeat"></i></span> <span class="author" itemprop="copyrightHolder">YaleXin</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">523k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">7:56</span></div> <span>本站已在此等候您 <span id="dnum" style="color:#35b8ff">0</span> 天</span> <span><span id="hnum" style="color:#35b8ff">0</span> 小时 <span id="mnum" style="color:#35b8ff">0</span> 分 <span id="snum" style="color:#35b8ff">0</span> 秒</span><script>var now=new Date;function createtime(){var n=new Date("02/21/2020 11:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("dnum").innerHTML=dnum,document.getElementById("hnum").innerHTML=hnum,document.getElementById("mnum").innerHTML=mnum,document.getElementById("snum").innerHTML=snum}setInterval("createtime()",250)</script><div class="powered-by"> <span>powered by</span> <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span> <span class="site-uv" title="总访客量"><span>总访客量：</span><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="site-pv" title="总访问量"><span>总访问量：</span><span id="busuanzi_value_site_pv"></span></span></span></div><script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.getAttribute('data-flag-title');

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=CjaKbRAizU0DNH3B4Hllhtwp-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id'     : 'CjaKbRAizU0DNH3B4Hllhtwp-gzGzoHsz',
            'X-LC-Key'    : 'B61jy2Xnwe90oJ2dtUeF6HHU',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.min.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script></body></html>